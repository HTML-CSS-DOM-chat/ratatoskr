"use strict";
var debug = require('debug')('ratatoskr:resume');
var RESUME_STEPS = [200, 1 * 1000, 5 * 1000, 10 * 1000, 30 * 1000, 60 * 1000];
function resume(_a) {
    var _b = _a === void 0 ? {} : _a, _c = _b.ping, ping = _c === void 0 ? 10 * 1000 : _c, _d = _b.retry, retry = _d === void 0 ? 6 : _d, _e = _b.steps, steps = _e === void 0 ? RESUME_STEPS : _e;
    return function (client) {
        var prevAckAt, thisAckAt;
        var pingTimeout;
        var resumeTimeout;
        var resumeAttempts = 0;
        function doPing() {
            var msg = {};
            client.emit('resume:ping', msg);
            debug('ping=', msg);
            client.sendPing().then(function (ack) {
                debug('pong=', ack);
                prevAckAt = thisAckAt, thisAckAt = Date.now();
                client.emit('resume:pong', ack);
                client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
                pingTimeout = setTimeout(function () { return doPing(); }, ping);
            }, function (err) {
                debug('error=', err);
                if (resumeAttempts === 0) {
                    client.disconnect(new Error('pong'));
                }
            });
        }
        function doResume() {
            resumeAttempts++;
            if (retry > -1 && resumeAttempts > retry) {
                debug('quit');
                client.emit('resume:quit');
                return;
            }
            var resumeDelay = steps[Math.min(resumeAttempts, steps.length) - 1];
            debug('attempt=', resumeAttempts, resumeDelay);
            client.emit('resume', resumeDelay, resumeAttempts);
            clearTimeout(resumeTimeout), resumeTimeout = null;
            resumeTimeout = setTimeout(function () { return client.connect(); }, resumeDelay);
        }
        client.on('authenticated', function () {
            debug('authenticated');
            prevAckAt = thisAckAt || Date.now(), thisAckAt = Date.now();
            client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
            pingTimeout = setTimeout(function () { return doPing(); }, ping);
            resumeAttempts = 0;
        });
        client.on('disconnected', function (reason) {
            debug('disconnected reason=', reason);
            clearTimeout(pingTimeout), pingTimeout = null;
            if (reason === client) {
                debug('stop');
                clearTimeout(resumeTimeout), resumeTimeout = null;
                if (resumeAttempts > 0) {
                    client.emit('resume:stop');
                }
                resumeAttempts = 0;
                return;
            }
            doResume();
        });
    };
}
exports.resume = resume;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2V4dGVuc2lvbnMvcmVzdW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFJQSxJQUFNLEtBQUssR0FBaUIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDakUsSUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFDLElBQUksRUFBRSxDQUFDLEdBQUMsSUFBSSxFQUFFLEVBQUUsR0FBQyxJQUFJLEVBQUUsRUFBRSxHQUFDLElBQUksRUFBRSxFQUFFLEdBQUMsSUFBSSxDQUFDLENBQUM7QUFRdEUsZ0JBQXVCLEVBQXVFO1FBQXZFLDRCQUF1RSxFQUF0RSxZQUFnQixFQUFoQixxQ0FBZ0IsRUFBRSxhQUFTLEVBQVQsOEJBQVMsRUFBRSxhQUFvQixFQUFwQix5Q0FBb0I7SUFDckUsTUFBTSxDQUFDLFVBQUMsTUFBYztRQUNsQixJQUFJLFNBQWlCLEVBQUUsU0FBaUIsQ0FBQztRQUN6QyxJQUFJLFdBQWdCLENBQUM7UUFDckIsSUFBSSxhQUFrQixDQUFDO1FBQ3ZCLElBQUksY0FBYyxHQUFXLENBQUMsQ0FBQztRQUUvQjtZQUNJLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRWhDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFcEIsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLEdBQUc7Z0JBQ3ZCLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRXBCLFNBQVMsR0FBRyxTQUFTLEVBQUUsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDOUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ2hDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLFNBQVMsR0FBRyxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUN4RSxXQUFXLEdBQUcsVUFBVSxDQUFDLGNBQU0sT0FBQSxNQUFNLEVBQUUsRUFBUixDQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDbkQsQ0FBQyxFQUFFLFVBQUMsR0FBRztnQkFDSCxLQUFLLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUtyQixFQUFFLENBQUMsQ0FBQyxjQUFjLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdkIsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN6QyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO1FBRUQ7WUFDSSxjQUFjLEVBQUUsQ0FBQztZQUVqQixFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksY0FBYyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFFZCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUMzQixNQUFNLENBQUM7WUFDWCxDQUFDO1lBRUQsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUVwRSxLQUFLLENBQUMsVUFBVSxFQUFFLGNBQWMsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUUvQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUM7WUFFbkQsWUFBWSxDQUFDLGFBQWEsQ0FBQyxFQUFFLGFBQWEsR0FBRyxJQUFJLENBQUM7WUFFbEQsYUFBYSxHQUFHLFVBQVUsQ0FBQyxjQUFNLE9BQUEsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFoQixDQUFnQixFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFFRCxNQUFNLENBQUMsRUFBRSxDQUFDLGVBQWUsRUFBRTtZQUN2QixLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7WUFFdkIsU0FBUyxHQUFHLFNBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUM1RCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxTQUFTLEdBQUcsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUN4RSxXQUFXLEdBQUcsVUFBVSxDQUFDLGNBQU0sT0FBQSxNQUFNLEVBQUUsRUFBUixDQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDL0MsY0FBYyxHQUFHLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxFQUFFLFVBQUMsTUFBTTtZQUM3QixLQUFLLENBQUMsc0JBQXNCLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFdEMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFdBQVcsR0FBRyxJQUFJLENBQUM7WUFFOUMsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3BCLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFHZCxZQUFZLENBQUMsYUFBYSxDQUFDLEVBQUUsYUFBYSxHQUFHLElBQUksQ0FBQztnQkFDbEQsRUFBRSxDQUFDLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3JCLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQy9CLENBQUM7Z0JBQ0QsY0FBYyxHQUFHLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxDQUFDO1lBQ1gsQ0FBQztZQUVELFFBQVEsRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUM7QUFDTixDQUFDO0FBbEZlLGNBQU0sU0FrRnJCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vdHlwaW5ncy9pbmRleC5kLnRzXCIgLz5cblxuaW1wb3J0IHtDbGllbnR9IGZyb20gJy4uL2NsaWVudCc7XG5cbmNvbnN0IGRlYnVnOiBEZWJ1Zy5Mb2dnZXIgPSByZXF1aXJlKCdkZWJ1ZycpKCdyYXRhdG9za3I6cmVzdW1lJyk7XG5jb25zdCBSRVNVTUVfU1RFUFMgPSBbMjAwLCAxKjEwMDAsIDUqMTAwMCwgMTAqMTAwMCwgMzAqMTAwMCwgNjAqMTAwMF07IC8vIDBzLCAxcywgNXMsIDEwcywgMzBzLCA2MHNcblxuZXhwb3J0IGludGVyZmFjZSBSZXN1bWVPcHRpb25zIHtcbiAgICBwaW5nPzogbnVtYmVyO1xuICAgIHJldHJ5PzogbnVtYmVyO1xuICAgIHN0ZXBzPzogQXJyYXk8bnVtYmVyPjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc3VtZSh7cGluZyA9IDEwICogMTAwMCwgcmV0cnkgPSA2LCBzdGVwcyA9IFJFU1VNRV9TVEVQU306IFJlc3VtZU9wdGlvbnMgPSB7fSkge1xuICAgIHJldHVybiAoY2xpZW50OiBDbGllbnQpID0+IHtcbiAgICAgICAgdmFyIHByZXZBY2tBdDogbnVtYmVyLCB0aGlzQWNrQXQ6IG51bWJlcjtcbiAgICAgICAgdmFyIHBpbmdUaW1lb3V0OiBhbnk7XG4gICAgICAgIHZhciByZXN1bWVUaW1lb3V0OiBhbnk7XG4gICAgICAgIHZhciByZXN1bWVBdHRlbXB0czogbnVtYmVyID0gMDtcblxuICAgICAgICBmdW5jdGlvbiBkb1BpbmcoKSB7XG4gICAgICAgICAgICB2YXIgbXNnID0ge307XG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnBpbmcnLCBtc2cpO1xuXG4gICAgICAgICAgICBkZWJ1ZygncGluZz0nLCBtc2cpO1xuXG4gICAgICAgICAgICBjbGllbnQuc2VuZFBpbmcoKS50aGVuKChhY2spID0+IHtcbiAgICAgICAgICAgICAgICBkZWJ1ZygncG9uZz0nLCBhY2spO1xuXG4gICAgICAgICAgICAgICAgcHJldkFja0F0ID0gdGhpc0Fja0F0LCB0aGlzQWNrQXQgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6cG9uZycsIGFjayk7XG4gICAgICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTp0aWNrJywgdGhpc0Fja0F0IC0gcHJldkFja0F0LCB0aGlzQWNrQXQsIHByZXZBY2tBdCk7XG4gICAgICAgICAgICAgICAgcGluZ1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IGRvUGluZygpLCBwaW5nKTtcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBkZWJ1ZygnZXJyb3I9JywgZXJyKTtcblxuICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBzb2NrZXQgaXMgY2xvc2VkLCBpdCB3aWxsIHRyaWdnZXIgYSBgZGlzY29ubmVjdGVkYCBldmVudCwgd2hpY2ggd2lsbCBpbiB0dXJuIHRyaWdnZXIgYGRvUmVzdW1lYCwgYW5kIHRoZW4gYW55IG1lc3NhZ2VzXG4gICAgICAgICAgICAgICAgLy8gYXdhaXRpbmcgYWNrbm93bGVkZ2VtZW50IHdpbGwgYmUgcmVqZWN0ZWQuICBJbiB0aGlzIG9yZGVyIG9mIGV2ZW50cywgdGhlIHJlc3VtZSBwcm9jZXNzIGhhcyBhbHJlYWR5IGJlZ3VuLCBzbyB3ZSBkbyBub3Qgd2FudCB0b1xuICAgICAgICAgICAgICAgIC8vIGRpc2Nvbm5lY3QgaGVyZS5cbiAgICAgICAgICAgICAgICBpZiAocmVzdW1lQXR0ZW1wdHMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50LmRpc2Nvbm5lY3QobmV3IEVycm9yKCdwb25nJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZG9SZXN1bWUoKSB7XG4gICAgICAgICAgICByZXN1bWVBdHRlbXB0cysrO1xuXG4gICAgICAgICAgICBpZiAocmV0cnkgPiAtMSAmJiByZXN1bWVBdHRlbXB0cyA+IHJldHJ5KSB7XG4gICAgICAgICAgICAgICAgZGVidWcoJ3F1aXQnKTtcblxuICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6cXVpdCcpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHJlc3VtZURlbGF5ID0gc3RlcHNbTWF0aC5taW4ocmVzdW1lQXR0ZW1wdHMsIHN0ZXBzLmxlbmd0aCkgLSAxXTtcblxuICAgICAgICAgICAgZGVidWcoJ2F0dGVtcHQ9JywgcmVzdW1lQXR0ZW1wdHMsIHJlc3VtZURlbGF5KTtcblxuICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZScsIHJlc3VtZURlbGF5LCByZXN1bWVBdHRlbXB0cyk7XG5cbiAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXN1bWVUaW1lb3V0KSwgcmVzdW1lVGltZW91dCA9IG51bGw7XG5cbiAgICAgICAgICAgIHJlc3VtZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IGNsaWVudC5jb25uZWN0KCksIHJlc3VtZURlbGF5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNsaWVudC5vbignYXV0aGVudGljYXRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIGRlYnVnKCdhdXRoZW50aWNhdGVkJyk7XG5cbiAgICAgICAgICAgIHByZXZBY2tBdCA9IHRoaXNBY2tBdCB8fCBEYXRlLm5vdygpLCB0aGlzQWNrQXQgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTp0aWNrJywgdGhpc0Fja0F0IC0gcHJldkFja0F0LCB0aGlzQWNrQXQsIHByZXZBY2tBdCk7XG4gICAgICAgICAgICBwaW5nVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gZG9QaW5nKCksIHBpbmcpO1xuICAgICAgICAgICAgcmVzdW1lQXR0ZW1wdHMgPSAwO1xuICAgICAgICB9KTtcblxuICAgICAgICBjbGllbnQub24oJ2Rpc2Nvbm5lY3RlZCcsIChyZWFzb24pID0+IHtcbiAgICAgICAgICAgIGRlYnVnKCdkaXNjb25uZWN0ZWQgcmVhc29uPScsIHJlYXNvbik7XG5cbiAgICAgICAgICAgIGNsZWFyVGltZW91dChwaW5nVGltZW91dCksIHBpbmdUaW1lb3V0ID0gbnVsbDtcblxuICAgICAgICAgICAgaWYgKHJlYXNvbiA9PT0gY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgZGVidWcoJ3N0b3AnKTtcblxuICAgICAgICAgICAgICAgIC8vIGRpc2Nvbm5lY3Qgd2FzIGNhbGxlZCBkaXJlY3RseSwgZG8gbm90IHJlc3VtZSwgY2FuY2VsIG91dHN0YW5kaW5nXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlc3VtZVRpbWVvdXQpLCByZXN1bWVUaW1lb3V0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAocmVzdW1lQXR0ZW1wdHMgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6c3RvcCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXN1bWVBdHRlbXB0cyA9IDA7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkb1Jlc3VtZSgpO1xuICAgICAgICB9KTtcbiAgICB9O1xufVxuIl19