"use strict";
var debug = require('debug')('ratatoskr:resume');
var RESUME_STEPS = [200, 1 * 1000, 5 * 1000, 10 * 1000, 30 * 1000, 60 * 1000];
function resume(_a) {
    var _b = _a === void 0 ? {} : _a, _c = _b.ping, ping = _c === void 0 ? 10 * 1000 : _c, _d = _b.retry, retry = _d === void 0 ? 6 : _d, _e = _b.steps, steps = _e === void 0 ? RESUME_STEPS : _e, _f = _b.jitter, jitter = _f === void 0 ? 1800 : _f;
    return function (client) {
        var prevAckAt, thisAckAt;
        var pingTimeout;
        var resumeTimeout;
        var resumeAttempts = 0;
        function doPing() {
            var msg = {};
            client.emit('resume:ping', msg);
            debug('ping=', msg);
            client.sendPing().then(function (ack) {
                debug('pong=', ack);
                prevAckAt = thisAckAt, thisAckAt = Date.now();
                client.emit('resume:pong', ack);
                client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
                pingTimeout = setTimeout(function () { return doPing(); }, ping);
            }, function (err) {
                debug('error=', err);
                if (resumeAttempts === 0) {
                    client.disconnect(new Error('pong'));
                }
            });
        }
        function doResume() {
            resumeAttempts++;
            if (retry > -1 && resumeAttempts > retry) {
                debug('quit');
                client.emit('resume:quit');
                return;
            }
            var resumeDelay = steps[Math.min(resumeAttempts, steps.length) - 1];
            debug('attempt=', resumeAttempts, resumeDelay);
            client.emit('resume', resumeDelay, resumeAttempts);
            clearTimeout(resumeTimeout), resumeTimeout = null;
            resumeTimeout = setTimeout(function () { return client.connect(); }, resumeDelay);
        }
        client.on('authenticated', function () {
            debug('authenticated');
            prevAckAt = thisAckAt || Date.now(), thisAckAt = Date.now();
            client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
            pingTimeout = setTimeout(function () { return doPing(); }, ping);
            resumeAttempts = 0;
        });
        client.on('disconnected', function (reason) {
            debug('disconnected reason=', reason);
            clearTimeout(pingTimeout), pingTimeout = null;
            if (reason === client) {
                debug('stop');
                clearTimeout(resumeTimeout), resumeTimeout = null;
                if (resumeAttempts > 0) {
                    client.emit('resume:stop');
                }
                resumeAttempts = 0;
                return;
            }
            if (jitter > 0 && resumeAttempts === 0) {
                var randomized = jitter * Math.random();
                debug('jitter first resume attempt=', randomized);
                setTimeout(function () { return doResume(); }, randomized);
            }
            else {
                doResume();
            }
        });
    };
}
exports.resume = resume;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2V4dGVuc2lvbnMvcmVzdW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFJQSxJQUFNLEtBQUssR0FBaUIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDakUsSUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFDLElBQUksRUFBRSxDQUFDLEdBQUMsSUFBSSxFQUFFLEVBQUUsR0FBQyxJQUFJLEVBQUUsRUFBRSxHQUFDLElBQUksRUFBRSxFQUFFLEdBQUMsSUFBSSxDQUFDLENBQUM7QUFTdEUsZ0JBQXVCLEVBQXNGO1FBQXRGLDRCQUFzRixFQUFyRixZQUFnQixFQUFoQixxQ0FBZ0IsRUFBRSxhQUFTLEVBQVQsOEJBQVMsRUFBRSxhQUFvQixFQUFwQix5Q0FBb0IsRUFBRSxjQUFhLEVBQWIsa0NBQWE7SUFDcEYsTUFBTSxDQUFDLFVBQUMsTUFBYztRQUNsQixJQUFJLFNBQWlCLEVBQUUsU0FBaUIsQ0FBQztRQUN6QyxJQUFJLFdBQWdCLENBQUM7UUFDckIsSUFBSSxhQUFrQixDQUFDO1FBQ3ZCLElBQUksY0FBYyxHQUFXLENBQUMsQ0FBQztRQUUvQjtZQUNJLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRWhDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFcEIsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLEdBQUc7Z0JBQ3ZCLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRXBCLFNBQVMsR0FBRyxTQUFTLEVBQUUsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDOUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FB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Q0FBQyxDQUFDLENBQUM7Z0JBQ3JDLElBQU0sVUFBVSxHQUFHLE1BQU0sR0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ3hDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxVQUFVLENBQUMsQ0FBQztnQkFDbEQsVUFBVSxDQUFDLGNBQU0sT0FBQSxRQUFRLEVBQUUsRUFBVixDQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDN0MsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLFFBQVEsRUFBRSxDQUFDO1lBQ2YsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQXhGZSxjQUFNLFNBd0ZyQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL3R5cGluZ3MvaW5kZXguZC50c1wiIC8+XG5cbmltcG9ydCB7Q2xpZW50fSBmcm9tICcuLi9jbGllbnQnO1xuXG5jb25zdCBkZWJ1ZzogRGVidWcuTG9nZ2VyID0gcmVxdWlyZSgnZGVidWcnKSgncmF0YXRvc2tyOnJlc3VtZScpO1xuY29uc3QgUkVTVU1FX1NURVBTID0gWzIwMCwgMSoxMDAwLCA1KjEwMDAsIDEwKjEwMDAsIDMwKjEwMDAsIDYwKjEwMDBdOyAvLyAwcywgMXMsIDVzLCAxMHMsIDMwcywgNjBzXG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzdW1lT3B0aW9ucyB7XG4gICAgcGluZz86IG51bWJlcjtcbiAgICByZXRyeT86IG51bWJlcjtcbiAgICBzdGVwcz86IEFycmF5PG51bWJlcj47XG4gICAgaml0dGVyPzogbnVtYmVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzdW1lKHtwaW5nID0gMTAgKiAxMDAwLCByZXRyeSA9IDYsIHN0ZXBzID0gUkVTVU1FX1NURVBTLCBqaXR0ZXIgPSAxODAwfTogUmVzdW1lT3B0aW9ucyA9IHt9KSB7XG4gICAgcmV0dXJuIChjbGllbnQ6IENsaWVudCkgPT4ge1xuICAgICAgICB2YXIgcHJldkFja0F0OiBudW1iZXIsIHRoaXNBY2tBdDogbnVtYmVyO1xuICAgICAgICB2YXIgcGluZ1RpbWVvdXQ6IGFueTtcbiAgICAgICAgdmFyIHJlc3VtZVRpbWVvdXQ6IGFueTtcbiAgICAgICAgdmFyIHJlc3VtZUF0dGVtcHRzOiBudW1iZXIgPSAwO1xuXG4gICAgICAgIGZ1bmN0aW9uIGRvUGluZygpIHtcbiAgICAgICAgICAgIHZhciBtc2cgPSB7fTtcbiAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6cGluZycsIG1zZyk7XG5cbiAgICAgICAgICAgIGRlYnVnKCdwaW5nPScsIG1zZyk7XG5cbiAgICAgICAgICAgIGNsaWVudC5zZW5kUGluZygpLnRoZW4oKGFjaykgPT4ge1xuICAgICAgICAgICAgICAgIGRlYnVnKCdwb25nPScsIGFjayk7XG5cbiAgICAgICAgICAgICAgICBwcmV2QWNrQXQgPSB0aGlzQWNrQXQsIHRoaXNBY2tBdCA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTpwb25nJywgYWNrKTtcbiAgICAgICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnRpY2snLCB0aGlzQWNrQXQgLSBwcmV2QWNrQXQsIHRoaXNBY2tBdCwgcHJldkFja0F0KTtcbiAgICAgICAgICAgICAgICBwaW5nVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gZG9QaW5nKCksIHBpbmcpO1xuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGRlYnVnKCdlcnJvcj0nLCBlcnIpO1xuXG4gICAgICAgICAgICAgICAgLy8gaWYgdGhlIHNvY2tldCBpcyBjbG9zZWQsIGl0IHdpbGwgdHJpZ2dlciBhIGBkaXNjb25uZWN0ZWRgIGV2ZW50LCB3aGljaCB3aWxsIGluIHR1cm4gdHJpZ2dlciBgZG9SZXN1bWVgLCBhbmQgdGhlbiBhbnkgbWVzc2FnZXNcbiAgICAgICAgICAgICAgICAvLyBhd2FpdGluZyBhY2tub3dsZWRnZW1lbnQgd2lsbCBiZSByZWplY3RlZC4gIEluIHRoaXMgb3JkZXIgb2YgZXZlbnRzLCB0aGUgcmVzdW1lIHByb2Nlc3MgaGFzIGFscmVhZHkgYmVndW4sIHNvIHdlIGRvIG5vdCB3YW50IHRvXG4gICAgICAgICAgICAgICAgLy8gZGlzY29ubmVjdCBoZXJlLlxuICAgICAgICAgICAgICAgIGlmIChyZXN1bWVBdHRlbXB0cyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBjbGllbnQuZGlzY29ubmVjdChuZXcgRXJyb3IoJ3BvbmcnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBkb1Jlc3VtZSgpIHtcbiAgICAgICAgICAgIHJlc3VtZUF0dGVtcHRzKys7XG5cbiAgICAgICAgICAgIGlmIChyZXRyeSA+IC0xICYmIHJlc3VtZUF0dGVtcHRzID4gcmV0cnkpIHtcbiAgICAgICAgICAgICAgICBkZWJ1ZygncXVpdCcpO1xuXG4gICAgICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTpxdWl0Jyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgcmVzdW1lRGVsYXkgPSBzdGVwc1tNYXRoLm1pbihyZXN1bWVBdHRlbXB0cywgc3RlcHMubGVuZ3RoKSAtIDFdO1xuXG4gICAgICAgICAgICBkZWJ1ZygnYXR0ZW1wdD0nLCByZXN1bWVBdHRlbXB0cywgcmVzdW1lRGVsYXkpO1xuXG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lJywgcmVzdW1lRGVsYXksIHJlc3VtZUF0dGVtcHRzKTtcblxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlc3VtZVRpbWVvdXQpLCByZXN1bWVUaW1lb3V0ID0gbnVsbDtcblxuICAgICAgICAgICAgcmVzdW1lVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gY2xpZW50LmNvbm5lY3QoKSwgcmVzdW1lRGVsYXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgY2xpZW50Lm9uKCdhdXRoZW50aWNhdGVkJywgKCkgPT4ge1xuICAgICAgICAgICAgZGVidWcoJ2F1dGhlbnRpY2F0ZWQnKTtcblxuICAgICAgICAgICAgcHJldkFja0F0ID0gdGhpc0Fja0F0IHx8IERhdGUubm93KCksIHRoaXNBY2tBdCA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnRpY2snLCB0aGlzQWNrQXQgLSBwcmV2QWNrQXQsIHRoaXNBY2tBdCwgcHJldkFja0F0KTtcbiAgICAgICAgICAgIHBpbmdUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiBkb1BpbmcoKSwgcGluZyk7XG4gICAgICAgICAgICByZXN1bWVBdHRlbXB0cyA9IDA7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNsaWVudC5vbignZGlzY29ubmVjdGVkJywgKHJlYXNvbikgPT4ge1xuICAgICAgICAgICAgZGVidWcoJ2Rpc2Nvbm5lY3RlZCByZWFzb249JywgcmVhc29uKTtcblxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHBpbmdUaW1lb3V0KSwgcGluZ1RpbWVvdXQgPSBudWxsO1xuXG4gICAgICAgICAgICBpZiAocmVhc29uID09PSBjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Zygnc3RvcCcpO1xuXG4gICAgICAgICAgICAgICAgLy8gZGlzY29ubmVjdCB3YXMgY2FsbGVkIGRpcmVjdGx5LCBkbyBub3QgcmVzdW1lLCBjYW5jZWwgb3V0c3RhbmRpbmdcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocmVzdW1lVGltZW91dCksIHJlc3VtZVRpbWVvdXQgPSBudWxsO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bWVBdHRlbXB0cyA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTpzdG9wJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc3VtZUF0dGVtcHRzID0gMDtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChqaXR0ZXIgPiAwICYmIHJlc3VtZUF0dGVtcHRzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmFuZG9taXplZCA9IGppdHRlcipNYXRoLnJhbmRvbSgpO1xuICAgICAgICAgICAgICAgIGRlYnVnKCdqaXR0ZXIgZmlyc3QgcmVzdW1lIGF0dGVtcHQ9JywgcmFuZG9taXplZCk7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBkb1Jlc3VtZSgpLCByYW5kb21pemVkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZG9SZXN1bWUoKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7XG4gICAgfTtcbn1cbiJdfQ==