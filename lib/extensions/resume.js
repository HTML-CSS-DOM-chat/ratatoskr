"use strict";
var debug = require('debug')('ratatoskr:resume');
var RESUME_STEPS = [200, 1 * 1000, 5 * 1000, 10 * 1000, 30 * 1000, 60 * 1000];
function resume(_a) {
    var _b = _a === void 0 ? {} : _a, _c = _b.ping, ping = _c === void 0 ? 10 * 1000 : _c, _d = _b.retry, retry = _d === void 0 ? 6 : _d, _e = _b.steps, steps = _e === void 0 ? RESUME_STEPS : _e;
    return function (client) {
        var prevAckAt, thisAckAt;
        var pingTimeout;
        var resumeTimeout;
        var resumeAttempts = 0;
        function doPing() {
            var msg = {};
            client.emit('resume:ping', msg);
            debug('ping=', msg);
            client.sendPing({}).then(function (ack) {
                debug('pong=', ack);
                prevAckAt = thisAckAt, thisAckAt = Date.now();
                client.emit('resume:pong', ack);
                client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
                pingTimeout = setTimeout(function () { return doPing(); }, ping);
            }, function (err) {
                debug('error=', err);
                if (resumeAttempts === 0) {
                    client.disconnect(new Error('pong'));
                }
            });
        }
        function doResume() {
            resumeAttempts++;
            if (retry > -1 && resumeAttempts > retry) {
                debug('quit');
                client.emit('resume:quit');
                return;
            }
            var resumeDelay = steps[Math.min(resumeAttempts, steps.length) - 1];
            debug('attempt=', resumeAttempts, resumeDelay);
            client.emit('resume', resumeDelay, resumeAttempts);
            clearTimeout(resumeTimeout), resumeTimeout = null;
            resumeTimeout = setTimeout(function () { return client.connect(); }, resumeDelay);
        }
        client.on('authenticated', function () {
            debug('authenticated');
            prevAckAt = thisAckAt || Date.now(), thisAckAt = Date.now();
            client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
            pingTimeout = setTimeout(function () { return doPing(); }, ping);
            resumeAttempts = 0;
        });
        client.on('disconnected', function (reason) {
            debug('disconnected reason=', reason);
            clearTimeout(pingTimeout), pingTimeout = null;
            if (reason === client) {
                debug('stop');
                clearTimeout(resumeTimeout), resumeTimeout = null;
                if (resumeAttempts > 0) {
                    client.emit('resume:stop');
                }
                resumeAttempts = 0;
                return;
            }
            doResume();
        });
    };
}
exports.resume = resume;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2V4dGVuc2lvbnMvcmVzdW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFJQSxJQUFNLEtBQUssR0FBaUIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDakUsSUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFDLElBQUksRUFBRSxDQUFDLEdBQUMsSUFBSSxFQUFFLEVBQUUsR0FBQyxJQUFJLEVBQUUsRUFBRSxHQUFDLElBQUksRUFBRSxFQUFFLEdBQUMsSUFBSSxDQUFDLENBQUM7QUFRdEUsZ0JBQXVCLEVBQXVFO1FBQXZFLDRCQUF1RSxFQUF0RSxZQUFnQixFQUFoQixxQ0FBZ0IsRUFBRSxhQUFTLEVBQVQsOEJBQVMsRUFBRSxhQUFvQixFQUFwQix5Q0FBb0I7SUFDckUsTUFBTSxDQUFDLFVBQUMsTUFBYztRQUNsQixJQUFJLFNBQWlCLEVBQUUsU0FBaUIsQ0FBQztRQUN6QyxJQUFJLFdBQWdCLENBQUM7UUFDckIsSUFBSSxhQUFrQixDQUFDO1FBQ3ZCLElBQUksY0FBYyxHQUFXLENBQUMsQ0FBQztRQUUvQjtZQUNJLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRWhDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFcEIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxHQUFHO2dCQUN6QixLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUVwQixTQUFTLEdBQUcsU0FBUyxFQUFFLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQzlDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFD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QWxGZSxjQUFNLFNBa0ZyQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL3R5cGluZ3MvaW5kZXguZC50c1wiIC8+XHJcblxyXG5pbXBvcnQge0NsaWVudH0gZnJvbSAnLi4vY2xpZW50JztcclxuXHJcbmNvbnN0IGRlYnVnOiBEZWJ1Zy5Mb2dnZXIgPSByZXF1aXJlKCdkZWJ1ZycpKCdyYXRhdG9za3I6cmVzdW1lJyk7XHJcbmNvbnN0IFJFU1VNRV9TVEVQUyA9IFsyMDAsIDEqMTAwMCwgNSoxMDAwLCAxMCoxMDAwLCAzMCoxMDAwLCA2MCoxMDAwXTsgLy8gMHMsIDFzLCA1cywgMTBzLCAzMHMsIDYwc1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZXN1bWVPcHRpb25zIHtcclxuICAgIHBpbmc/OiBudW1iZXI7XHJcbiAgICByZXRyeT86IG51bWJlcjtcclxuICAgIHN0ZXBzPzogQXJyYXk8bnVtYmVyPjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJlc3VtZSh7cGluZyA9IDEwICogMTAwMCwgcmV0cnkgPSA2LCBzdGVwcyA9IFJFU1VNRV9TVEVQU306IFJlc3VtZU9wdGlvbnMgPSB7fSkge1xyXG4gICAgcmV0dXJuIChjbGllbnQ6IENsaWVudCkgPT4ge1xyXG4gICAgICAgIHZhciBwcmV2QWNrQXQ6IG51bWJlciwgdGhpc0Fja0F0OiBudW1iZXI7XHJcbiAgICAgICAgdmFyIHBpbmdUaW1lb3V0OiBhbnk7XHJcbiAgICAgICAgdmFyIHJlc3VtZVRpbWVvdXQ6IGFueTtcclxuICAgICAgICB2YXIgcmVzdW1lQXR0ZW1wdHM6IG51bWJlciA9IDA7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGRvUGluZygpIHtcclxuICAgICAgICAgICAgdmFyIG1zZyA9IHt9O1xyXG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnBpbmcnLCBtc2cpO1xyXG5cclxuICAgICAgICAgICAgZGVidWcoJ3Bpbmc9JywgbXNnKTtcclxuXHJcbiAgICAgICAgICAgIGNsaWVudC5zZW5kUGluZyh7fSkudGhlbigoYWNrKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZygncG9uZz0nLCBhY2spO1xyXG5cclxuICAgICAgICAgICAgICAgIHByZXZBY2tBdCA9IHRoaXNBY2tBdCwgdGhpc0Fja0F0ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6cG9uZycsIGFjayk7XHJcbiAgICAgICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnRpY2snLCB0aGlzQWNrQXQgLSBwcmV2QWNrQXQsIHRoaXNBY2tBdCwgcHJldkFja0F0KTtcclxuICAgICAgICAgICAgICAgIHBpbmdUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiBkb1BpbmcoKSwgcGluZyk7XHJcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKCdlcnJvcj0nLCBlcnIpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBzb2NrZXQgaXMgY2xvc2VkLCBpdCB3aWxsIHRyaWdnZXIgYSBgZGlzY29ubmVjdGVkYCBldmVudCwgd2hpY2ggd2lsbCBpbiB0dXJuIHRyaWdnZXIgYGRvUmVzdW1lYCwgYW5kIHRoZW4gYW55IG1lc3NhZ2VzXHJcbiAgICAgICAgICAgICAgICAvLyBhd2FpdGluZyBhY2tub3dsZWRnZW1lbnQgd2lsbCBiZSByZWplY3RlZC4gIEluIHRoaXMgb3JkZXIgb2YgZXZlbnRzLCB0aGUgcmVzdW1lIHByb2Nlc3MgaGFzIGFscmVhZHkgYmVndW4sIHNvIHdlIGRvIG5vdCB3YW50IHRvXHJcbiAgICAgICAgICAgICAgICAvLyBkaXNjb25uZWN0IGhlcmUuXHJcbiAgICAgICAgICAgICAgICBpZiAocmVzdW1lQXR0ZW1wdHMgPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGllbnQuZGlzY29ubmVjdChuZXcgRXJyb3IoJ3BvbmcnKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZG9SZXN1bWUoKSB7XHJcbiAgICAgICAgICAgIHJlc3VtZUF0dGVtcHRzKys7XHJcblxyXG4gICAgICAgICAgICBpZiAocmV0cnkgPiAtMSAmJiByZXN1bWVBdHRlbXB0cyA+IHJldHJ5KSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZygncXVpdCcpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6cXVpdCcpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgcmVzdW1lRGVsYXkgPSBzdGVwc1tNYXRoLm1pbihyZXN1bWVBdHRlbXB0cywgc3RlcHMubGVuZ3RoKSAtIDFdO1xyXG5cclxuICAgICAgICAgICAgZGVidWcoJ2F0dGVtcHQ9JywgcmVzdW1lQXR0ZW1wdHMsIHJlc3VtZURlbGF5KTtcclxuXHJcbiAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWUnLCByZXN1bWVEZWxheSwgcmVzdW1lQXR0ZW1wdHMpO1xyXG5cclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlc3VtZVRpbWVvdXQpLCByZXN1bWVUaW1lb3V0ID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgIHJlc3VtZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IGNsaWVudC5jb25uZWN0KCksIHJlc3VtZURlbGF5KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNsaWVudC5vbignYXV0aGVudGljYXRlZCcsICgpID0+IHtcclxuICAgICAgICAgICAgZGVidWcoJ2F1dGhlbnRpY2F0ZWQnKTtcclxuXHJcbiAgICAgICAgICAgIHByZXZBY2tBdCA9IHRoaXNBY2tBdCB8fCBEYXRlLm5vdygpLCB0aGlzQWNrQXQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnRpY2snLCB0aGlzQWNrQXQgLSBwcmV2QWNrQXQsIHRoaXNBY2tBdCwgcHJldkFja0F0KTtcclxuICAgICAgICAgICAgcGluZ1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IGRvUGluZygpLCBwaW5nKTtcclxuICAgICAgICAgICAgcmVzdW1lQXR0ZW1wdHMgPSAwO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjbGllbnQub24oJ2Rpc2Nvbm5lY3RlZCcsIChyZWFzb24pID0+IHtcclxuICAgICAgICAgICAgZGVidWcoJ2Rpc2Nvbm5lY3RlZCByZWFzb249JywgcmVhc29uKTtcclxuXHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dChwaW5nVGltZW91dCksIHBpbmdUaW1lb3V0ID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgIGlmIChyZWFzb24gPT09IGNsaWVudCkge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoJ3N0b3AnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBkaXNjb25uZWN0IHdhcyBjYWxsZWQgZGlyZWN0bHksIGRvIG5vdCByZXN1bWUsIGNhbmNlbCBvdXRzdGFuZGluZ1xyXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlc3VtZVRpbWVvdXQpLCByZXN1bWVUaW1lb3V0ID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIGlmIChyZXN1bWVBdHRlbXB0cyA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnN0b3AnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc3VtZUF0dGVtcHRzID0gMDtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZG9SZXN1bWUoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbn1cclxuIl19