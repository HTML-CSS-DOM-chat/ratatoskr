"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var events_1 = require('events');
var WebSocket = require('ws');
var shortid = require('shortid');
var debug = require('debug')('ratatoskr:client');
(function (ConnectionStatus) {
    ConnectionStatus[ConnectionStatus["Disconnected"] = 0] = "Disconnected";
    ConnectionStatus[ConnectionStatus["Connecting"] = 1] = "Connecting";
    ConnectionStatus[ConnectionStatus["Connected"] = 2] = "Connected";
    ConnectionStatus[ConnectionStatus["Authenticated"] = 3] = "Authenticated";
})(exports.ConnectionStatus || (exports.ConnectionStatus = {}));
var ConnectionStatus = exports.ConnectionStatus;
(function (MessageSendErrorCause) {
    MessageSendErrorCause[MessageSendErrorCause["NoConnection"] = 0] = "NoConnection";
    MessageSendErrorCause[MessageSendErrorCause["NoAuth"] = 1] = "NoAuth";
    MessageSendErrorCause[MessageSendErrorCause["NoAck"] = 2] = "NoAck";
    MessageSendErrorCause[MessageSendErrorCause["Serialization"] = 3] = "Serialization";
    MessageSendErrorCause[MessageSendErrorCause["Transport"] = 4] = "Transport";
    MessageSendErrorCause[MessageSendErrorCause["Promise"] = 5] = "Promise";
})(exports.MessageSendErrorCause || (exports.MessageSendErrorCause = {}));
var MessageSendErrorCause = exports.MessageSendErrorCause;
var MessageSendError = (function (_super) {
    __extends(MessageSendError, _super);
    function MessageSendError(message, cause, source, data) {
        _super.call(this, message);
        this.cause = cause;
        this.source = source;
        this.data = data;
    }
    return MessageSendError;
}(Error));
exports.MessageSendError = MessageSendError;
var Client = (function (_super) {
    __extends(Client, _super);
    function Client(_a) {
        var _this = this;
        var _b = _a === void 0 ? {} : _a, endpoint = _b.endpoint, authorization = _b.authorization, _c = _b.timeout, timeout = _c === void 0 ? 5 * 1000 : _c, _d = _b.resource, resource = _d === void 0 ? '' : _d, _e = _b.agent, agent = _e === void 0 ? 'Ratatoskr' : _e, _f = _b.extensions, extensions = _f === void 0 ? [] : _f;
        _super.call(this);
        this.status = ConnectionStatus.Disconnected;
        this.timeout = 5 * 1000;
        this._needsAck = {};
        this.agent = agent;
        this.resource = resource;
        this.endpoint = endpoint;
        this.authorization = authorization;
        this.timeout = timeout;
        extensions.forEach(function (ext) { return _this.use(ext); });
    }
    Client.prototype.use = function (ext) {
        if (typeof ext.prototype.init === 'function') {
            (new ext()).init(this);
        }
        else if (typeof ext.init === 'function') {
            ext.init(this);
        }
        else if (typeof ext === 'function') {
            ext(this);
        }
    };
    Client.prototype.nextId = function () {
        return shortid.generate();
    };
    Client.prototype.connect = function () {
        var _this = this;
        if (this.status !== ConnectionStatus.Disconnected) {
            return;
        }
        this.status = ConnectionStatus.Connecting;
        debug('connect endpoint=', this.endpoint);
        this.emit('connecting');
        var socket = new WebSocket(this.endpoint, ['ratatoskr']);
        socket.onopen = function (evt) {
            debug('connect onopen=', evt);
            _this._wsBind(socket);
        };
        socket.onerror = function (evt) {
            debug('connect onerror=', evt);
            _this.emit('transport:error', evt);
            _this._wsDisconnect(socket, evt);
        };
        socket.onclose = function (evt) {
            debug('connect onclose=', evt);
            _this.emit('transport:close', evt);
            _this._wsDisconnect(socket, evt);
        };
    };
    Client.prototype.disconnect = function (reason) {
        if (reason === void 0) { reason = this; }
        this._wsDisconnect(this._socket, reason);
    };
    Client.prototype._wsDisconnect = function (socket, reason) {
        var _this = this;
        debug('disconnect reason=', reason);
        try {
            if (socket) {
                socket.onopen = null;
                socket.onerror = null;
                socket.onmessage = null;
                socket.onclose = null;
                socket.close();
            }
        }
        catch (err) {
        }
        finally {
            this._socket = null;
        }
        Object.keys(this._needsAck).forEach(function (k) {
            _this._needsAck[k].error(reason);
        }), this._needsAck = {};
        this.status = ConnectionStatus.Disconnected;
        this.emit('disconnected', reason);
    };
    Client.prototype._wsBind = function (socket) {
        var _this = this;
        socket.onopen = null;
        socket.onerror = this._wsError.bind(this);
        socket.onmessage = this._wsMessage.bind(this);
        socket.onclose = this._wsClose.bind(this);
        this._socket = socket;
        this.status = ConnectionStatus.Connected;
        this.emit('connected');
        var auth;
        auth = typeof this.authorization === 'function' ? this.authorization() : this.authorization;
        var message = {
            id: this.nextId(),
            type: 'auth',
            authorization: auth
        };
        if (this.agent)
            message.agent = this.agent;
        if (this.resource)
            message.resource = this.resource;
        this._wsSend(message).then(function (ack) {
            debug('authentication ack=', ack);
            _this.status = ConnectionStatus.Authenticated;
            _this.emit('authenticated', ack);
        }, function (err) {
            debug('authentication error=', err);
            _this.emit('protocol:error', err);
            _this._wsDisconnect(_this._socket, err);
        });
    };
    Client.prototype._wsInboundError = function (message) {
        if (message.code === 'auth_failed') {
            debug('authentication failure=', message);
            this._wsDisconnect(this._socket, message);
        }
        else {
            this.emit('protocol:error', message);
            var ack = this._needsAck[message.id];
            if (ack) {
                ack.error(message);
            }
        }
    };
    Client.prototype._wsInboundAck = function (message) {
        var ack = this._needsAck[message.reply_to];
        if (ack) {
            message.error ? ack.error(message.error) : ack.ok(message);
        }
    };
    Client.prototype._wsInboundOther = function (message) {
        this.emit("" + message.type, message);
    };
    Client.prototype._wsMessage = function (evt) {
        try {
            this.emit('raw:incomming', evt.data);
            var message = JSON.parse(evt.data);
            debug('receive=', message);
            if (message.type === 'error') {
                this._wsInboundError(message);
            }
            else if (message.type === 'ack') {
                this._wsInboundAck(message);
            }
            else {
                this._wsInboundOther(message);
            }
        }
        catch (err) {
            this.emit('protocol:error', err);
        }
    };
    Client.prototype._wsError = function (evt) {
        this.emit('transport:error', evt);
        this._wsDisconnect(this._socket, evt);
    };
    Client.prototype._wsClose = function (evt) {
        this.emit('transport:close', evt);
        this._wsDisconnect(this._socket, evt);
    };
    Client.prototype._wsSend = function (message, timeout) {
        var _this = this;
        if (timeout === void 0) { timeout = this.timeout; }
        if (this.status < ConnectionStatus.Connected) {
            return Promise.reject(new MessageSendError('Cannot send data across a socket that is not connected.', MessageSendErrorCause.NoAuth));
        }
        debug('send=', message);
        var data;
        try {
            data = JSON.stringify(message);
        }
        catch (err) {
            this.emit('protocol:error', err);
            return Promise.reject(new MessageSendError('Could not serialize message.', MessageSendErrorCause.Serialization, err, message));
        }
        this.emit('raw:outgoing', data);
        try {
            var socket = this._socket;
            socket.send(data);
            if (socket !== this._socket) {
                throw new Error('Socket was destroyed during send.');
            }
        }
        catch (err) {
            debug('send err=', err);
            this.emit('transport:error', err);
            return Promise.reject(new MessageSendError('An error occurred in the transport.', MessageSendErrorCause.Transport, err, message));
        }
        if (message.id) {
            var id_1 = message.id;
            var context_1 = this._needsAck[id_1] = { id: id_1 };
            var promise = new Promise(function (ok, err) {
                context_1.ok = ok;
                context_1.error = err;
            });
            var timer_1 = setTimeout(function () {
                debug('ack timeout=', timeout);
                context_1.error(new MessageSendError('Did not receive acknowledgement in the timeout period.', MessageSendErrorCause.NoAck, void 0, message));
            }, timeout);
            var cleanup_1 = function () {
                clearTimeout(timer_1);
                delete _this._needsAck[id_1];
            };
            return promise.then(function (ack) {
                debug('ack=', ack);
                cleanup_1();
                return ack;
            }, function (err) {
                debug('ack error=', err);
                cleanup_1();
                throw new MessageSendError('An error occurred during promise resolution', MessageSendErrorCause.Promise, err, message);
            });
        }
        else {
            return Promise.resolve();
        }
    };
    Client.prototype.send = function (message) {
        if (this.status < ConnectionStatus.Authenticated) {
            return Promise.reject(new MessageSendError('Cannot send data across a socket that is not authenticated.', MessageSendErrorCause.NoAuth, void 0, message));
        }
        return this._wsSend(message);
    };
    Client.prototype._ensureCanAck = function (ack, message) {
        if (ack && !('id' in message)) {
            message.id = this.nextId();
        }
        return message;
    };
    Client.prototype.sendPing = function (message, ack) {
        if (message === void 0) { message = {}; }
        if (ack === void 0) { ack = true; }
        message.type = 'ping';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendChat = function (message, ack) {
        if (ack === void 0) { ack = true; }
        message.type = 'chat';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendPresenceChange = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'presence_change';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendUserTyping = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'user_typing';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendTeamJoin = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'team_join';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendTeamLeave = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'team_leave';
        return this.send(this._ensureCanAck(ack, message));
    };
    return Client;
}(events_1.EventEmitter));
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSx1QkFBMkIsUUFBUSxDQUFDLENBQUE7QUFFcEMsSUFBWSxTQUFTLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFDaEMsSUFBWSxPQUFPLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFHbkMsSUFBTSxLQUFLLEdBQWlCLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBRWpFLFdBQVksZ0JBQWdCO0lBQ3hCLHVFQUFnQixDQUFBO0lBQ2hCLG1FQUFjLENBQUE7SUFDZCxpRUFBYSxDQUFBO0lBQ2IseUVBQWlCLENBQUE7QUFDckIsQ0FBQyxFQUxXLHdCQUFnQixLQUFoQix3QkFBZ0IsUUFLM0I7QUFMRCxJQUFZLGdCQUFnQixHQUFoQix3QkFLWCxDQUFBO0FBOEJELFdBQVkscUJBQXFCO0lBQzdCLGlGQUFnQixDQUFBO0lBQ2hCLHFFQUFVLENBQUE7SUFDVixtRUFBUyxDQUFBO0lBQ1QsbUZBQWlCLENBQUE7SUFDakIsMkVBQWEsQ0FBQTtJQUNiLHVFQUFXLENBQUE7QUFDZixDQUFDLEVBUFcsNkJBQXFCLEtBQXJCLDZCQUFxQixRQU9oQztBQVBELElBQVkscUJBQXFCLEdBQXJCLDZCQU9YLENBQUE7QUFFRDtJQUFzQyxvQ0FBSztJQUt2QywwQkFBWSxPQUFlLEVBQUUsS0FBNEIsRUFBRSxNQUFZLEVBQUUsSUFBZTtRQUNwRixrQkFBTSxPQUFPLENBQUMsQ0FBQztRQUVmLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFDTCx1QkFBQztBQUFELENBQUMsQUFaRCxDQUFzQyxLQUFLLEdBWTFDO0FBWlksd0JBQWdCLG1CQVk1QixD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cGF0aD1cIi4uL3R5cGluZ3MvaW5kZXguZC50c1wiIC8+XG5cbmltcG9ydCB7RXZlbnRFbWl0dGVyfSBmcm9tICdldmVudHMnO1xuaW1wb3J0ICogYXMgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgKiBhcyBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0ICogYXMgc2hvcnRpZCBmcm9tICdzaG9ydGlkJztcbmltcG9ydCB7QWNrLCBFcnJvciwgT3RoZXIsIEF1dGgsIENoYXQsIFByZXNlbmNlQ2hhbmdlLCBVc2VyVHlwaW5nLCBQaW5nLCBUZWFtSm9pbiwgVGVhbUxlYXZlLCBPdXRib3VuZCwgSW5ib3VuZH0gZnJvbSAnLi9pbnRlcmZhY2VzLmQnO1xuXG5jb25zdCBkZWJ1ZzogRGVidWcuTG9nZ2VyID0gcmVxdWlyZSgnZGVidWcnKSgncmF0YXRvc2tyOmNsaWVudCcpO1xuXG5leHBvcnQgZW51bSBDb25uZWN0aW9uU3RhdHVzIHtcbiAgICBEaXNjb25uZWN0ZWQgPSAwLFxuICAgIENvbm5lY3RpbmcgPSAxLFxuICAgIENvbm5lY3RlZCA9IDIsXG4gICAgQXV0aGVudGljYXRlZCA9IDNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0aW9uT3B0aW9ucyB7XG4gICAgZW5kcG9pbnQ/OiBzdHJpbmc7XG4gICAgYXV0aG9yaXphdGlvbj86IHN0cmluZyB8IEF1dGhvcml6YXRpb25GdW5jO1xuICAgIHJlc291cmNlPzogc3RyaW5nO1xuICAgIGFnZW50Pzogc3RyaW5nO1xuICAgIHRpbWVvdXQ/OiBudW1iZXI7XG4gICAgZXh0ZW5zaW9ucz86IGFueVtdO1xufVxuXG5cbmV4cG9ydCBpbnRlcmZhY2UgUGVuZGluZ0Fja0NvbnRleHQgeyBcbiAgICBpZDogc3RyaW5nOyAgICAgXG4gICAgb2s6IChkYXRhOmFueSkgPT4gdm9pZDtcbiAgICBlcnJvcjogKGVycjphbnkpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aG9yaXphdGlvbkZ1bmMge1xuICAgICgpOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZW5zaW9uIHtcbiAgICBpbml0KGNsaWVudDogQ2xpZW50KTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb25Bc0Z1bmMge1xuICAgIChjbGllbnQ6IENsaWVudCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBlbnVtIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZSB7XG4gICAgTm9Db25uZWN0aW9uID0gMCxcbiAgICBOb0F1dGggPSAxLFxuICAgIE5vQWNrID0gMixcbiAgICBTZXJpYWxpemF0aW9uID0gMyxcbiAgICBUcmFuc3BvcnQgPSA0LFxuICAgIFByb21pc2UgPSA1XG59XG5cbmV4cG9ydCBjbGFzcyBNZXNzYWdlU2VuZEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICAgIGRhdGE6IE91dGJvdW5kO1xuICAgIGNhdXNlOiBNZXNzYWdlU2VuZEVycm9yQ2F1c2U7XG4gICAgc291cmNlOiBhbnk7XG5cbiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcsIGNhdXNlOiBNZXNzYWdlU2VuZEVycm9yQ2F1c2UsIHNvdXJjZT86IGFueSwgZGF0YT86IE91dGJvdW5kKSB7XG4gICAgICAgIHN1cGVyKG1lc3NhZ2UpO1xuXG4gICAgICAgIHRoaXMuY2F1c2UgPSBjYXVzZTtcbiAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7XG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7ICAgICAgICBcbiAgICB9XG59XG5cbi8qKlxuICovXG5leHBvcnQgY2xhc3MgQ2xpZW50IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBzdGF0dXM6IENvbm5lY3Rpb25TdGF0dXMgPSBDb25uZWN0aW9uU3RhdHVzLkRpc2Nvbm5lY3RlZDtcbiAgICByZXNvdXJjZTogc3RyaW5nO1xuICAgIGFnZW50OiBzdHJpbmc7XG4gICAgZW5kcG9pbnQ6IHN0cmluZztcbiAgICBhdXRob3JpemF0aW9uOiBzdHJpbmcgfCBBdXRob3JpemF0aW9uRnVuYztcbiAgICB0aW1lb3V0OiBudW1iZXIgPSA1ICogMTAwMDtcblxuICAgIHByb3RlY3RlZCBfc29ja2V0OiBXZWJTb2NrZXQ7XG4gICAgcHJvdGVjdGVkIF9uZWVkc0Fjazoge1tpZDpzdHJpbmddOlBlbmRpbmdBY2tDb250ZXh0fSA9IHt9O1xuXG4gICAgY29uc3RydWN0b3Ioe2VuZHBvaW50LCBhdXRob3JpemF0aW9uLCB0aW1lb3V0ID0gNSAqIDEwMDAsIHJlc291cmNlID0gJycsIGFnZW50ID0gJ1JhdGF0b3NrcicsIGV4dGVuc2lvbnMgPSBbXX06IENvbm5lY3Rpb25PcHRpb25zID0ge30pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLmFnZW50ID0gYWdlbnQ7XG4gICAgICAgIHRoaXMucmVzb3VyY2UgPSByZXNvdXJjZTtcbiAgICAgICAgdGhpcy5lbmRwb2ludCA9IGVuZHBvaW50O1xuICAgICAgICB0aGlzLmF1dGhvcml6YXRpb24gPSBhdXRob3JpemF0aW9uO1xuICAgICAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0O1xuXG4gICAgICAgIGV4dGVuc2lvbnMuZm9yRWFjaCgoZXh0KSA9PiB0aGlzLnVzZShleHQpKTtcbiAgICB9XG5cbiAgICB1c2UoZXh0OiBFeHRlbnNpb24pO1xuICAgIHVzZShleHQ6IEV4dGVuc2lvbkFzRnVuYyk7XG4gICAgdXNlKGV4dDogYW55KSB7XG4gICAgICAgIGlmICh0eXBlb2YgZXh0LnByb3RvdHlwZS5pbml0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAobmV3IGV4dCgpKS5pbml0KHRoaXMpO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHQuaW5pdCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgZXh0LmluaXQodGhpcyk7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4dCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgZXh0KHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmV4dElkKCkge1xuICAgICAgICByZXR1cm4gc2hvcnRpZC5nZW5lcmF0ZSgpO1xuICAgIH1cblxuICAgIGNvbm5lY3QoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyAhPT0gQ29ubmVjdGlvblN0YXR1cy5EaXNjb25uZWN0ZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RhdHVzID0gQ29ubmVjdGlvblN0YXR1cy5Db25uZWN0aW5nO1xuXG4gICAgICAgIGRlYnVnKCdjb25uZWN0IGVuZHBvaW50PScsIHRoaXMuZW5kcG9pbnQpO1xuXG4gICAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGluZycpO1xuXG4gICAgICAgIHZhciBzb2NrZXQgPSBuZXcgV2ViU29ja2V0KHRoaXMuZW5kcG9pbnQsIFsncmF0YXRvc2tyJ10pO1xuXG4gICAgICAgIHNvY2tldC5vbm9wZW4gPSAoZXZ0KSA9PiB7XG4gICAgICAgICAgICBkZWJ1ZygnY29ubmVjdCBvbm9wZW49JywgZXZ0KTtcblxuICAgICAgICAgICAgdGhpcy5fd3NCaW5kKHNvY2tldCk7XG4gICAgICAgIH07XG4gICAgICAgIHNvY2tldC5vbmVycm9yID0gKGV2dCkgPT4ge1xuICAgICAgICAgICAgZGVidWcoJ2Nvbm5lY3Qgb25lcnJvcj0nLCBldnQpO1xuXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3RyYW5zcG9ydDplcnJvcicsIGV2dCk7XG4gICAgICAgICAgICB0aGlzLl93c0Rpc2Nvbm5lY3Qoc29ja2V0LCBldnQpO1xuICAgICAgICB9O1xuICAgICAgICBzb2NrZXQub25jbG9zZSA9IChldnQpID0+IHtcbiAgICAgICAgICAgIGRlYnVnKCdjb25uZWN0IG9uY2xvc2U9JywgZXZ0KTtcblxuICAgICAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnQ6Y2xvc2UnLCBldnQpO1xuICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHNvY2tldCwgZXZ0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRpc2Nvbm5lY3QocmVhc29uOiBhbnkgPSB0aGlzKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3dzRGlzY29ubmVjdCh0aGlzLl9zb2NrZXQsIHJlYXNvbik7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93c0Rpc2Nvbm5lY3Qoc29ja2V0OiBXZWJTb2NrZXQsIHJlYXNvbj86IGFueSk6IHZvaWQge1xuICAgICAgICBkZWJ1ZygnZGlzY29ubmVjdCByZWFzb249JywgcmVhc29uKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKHNvY2tldCkge1xuICAgICAgICAgICAgICAgIHNvY2tldC5vbm9wZW4gPSBudWxsO1xuICAgICAgICAgICAgICAgIHNvY2tldC5vbmVycm9yID0gbnVsbDtcbiAgICAgICAgICAgICAgICBzb2NrZXQub25tZXNzYWdlID0gbnVsbDtcbiAgICAgICAgICAgICAgICBzb2NrZXQub25jbG9zZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgc29ja2V0LmNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgLy8gbm90aGluZyB0byBkbyBoZXJlLCB3ZSBhcmUgcmVsZWFzaW5nIHRoZSBzb2NrZXRcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIHRoaXMuX3NvY2tldCA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9uZWVkc0FjaykuZm9yRWFjaCgoaykgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbmVlZHNBY2tba10uZXJyb3IocmVhc29uKTtcbiAgICAgICAgfSksIHRoaXMuX25lZWRzQWNrID0ge307XG5cbiAgICAgICAgdGhpcy5zdGF0dXMgPSBDb25uZWN0aW9uU3RhdHVzLkRpc2Nvbm5lY3RlZDtcblxuICAgICAgICB0aGlzLmVtaXQoJ2Rpc2Nvbm5lY3RlZCcsIHJlYXNvbik7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93c0JpbmQoc29ja2V0OiBXZWJTb2NrZXQpOiB2b2lkIHtcbiAgICAgICAgc29ja2V0Lm9ub3BlbiA9IG51bGw7XG4gICAgICAgIHNvY2tldC5vbmVycm9yID0gdGhpcy5fd3NFcnJvci5iaW5kKHRoaXMpO1xuICAgICAgICBzb2NrZXQub25tZXNzYWdlID0gdGhpcy5fd3NNZXNzYWdlLmJpbmQodGhpcyk7XG4gICAgICAgIHNvY2tldC5vbmNsb3NlID0gdGhpcy5fd3NDbG9zZS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuX3NvY2tldCA9IHNvY2tldDtcblxuICAgICAgICB0aGlzLnN0YXR1cyA9IENvbm5lY3Rpb25TdGF0dXMuQ29ubmVjdGVkO1xuXG4gICAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGVkJyk7XG5cbiAgICAgICAgdmFyIGF1dGg6IHN0cmluZztcblxuICAgICAgICBhdXRoID0gdHlwZW9mIHRoaXMuYXV0aG9yaXphdGlvbiA9PT0gJ2Z1bmN0aW9uJyA/ICg8QXV0aG9yaXphdGlvbkZ1bmM+dGhpcy5hdXRob3JpemF0aW9uKSgpIDogPHN0cmluZz50aGlzLmF1dGhvcml6YXRpb247XG5cbiAgICAgICAgdmFyIG1lc3NhZ2UgPSA8QXV0aD57XG4gICAgICAgICAgICBpZDogdGhpcy5uZXh0SWQoKSxcbiAgICAgICAgICAgIHR5cGU6ICdhdXRoJyxcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb246IGF1dGhcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodGhpcy5hZ2VudCkgbWVzc2FnZS5hZ2VudCA9IHRoaXMuYWdlbnQ7XG4gICAgICAgIGlmICh0aGlzLnJlc291cmNlKSBtZXNzYWdlLnJlc291cmNlID0gdGhpcy5yZXNvdXJjZTtcblxuICAgICAgICB0aGlzLl93c1NlbmQobWVzc2FnZSkudGhlbigoYWNrKSA9PiB7XG4gICAgICAgICAgICBkZWJ1ZygnYXV0aGVudGljYXRpb24gYWNrPScsIGFjayk7XG5cbiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gQ29ubmVjdGlvblN0YXR1cy5BdXRoZW50aWNhdGVkO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdhdXRoZW50aWNhdGVkJywgYWNrKTtcbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgZGVidWcoJ2F1dGhlbnRpY2F0aW9uIGVycm9yPScsIGVycik7XG5cbiAgICAgICAgICAgIHRoaXMuZW1pdCgncHJvdG9jb2w6ZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgZXJyKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93c0luYm91bmRFcnJvcihtZXNzYWdlOiBFcnJvcikge1xuICAgICAgICBpZiAobWVzc2FnZS5jb2RlID09PSAnYXV0aF9mYWlsZWQnKSB7XG4gICAgICAgICAgICBkZWJ1ZygnYXV0aGVudGljYXRpb24gZmFpbHVyZT0nLCBtZXNzYWdlKTtcbiAgICAgICAgICAgIHRoaXMuX3dzRGlzY29ubmVjdCh0aGlzLl9zb2NrZXQsIG1lc3NhZ2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdwcm90b2NvbDplcnJvcicsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgY29uc3QgYWNrID0gdGhpcy5fbmVlZHNBY2tbbWVzc2FnZS5pZF07ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChhY2spIHtcbiAgICAgICAgICAgICAgICBhY2suZXJyb3IobWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3dzSW5ib3VuZEFjayhtZXNzYWdlOiBBY2spIHtcbiAgICAgICAgY29uc3QgYWNrID0gdGhpcy5fbmVlZHNBY2tbbWVzc2FnZS5yZXBseV90b107ICAgICAgICAgICAgICAgIFxuICAgICAgICBpZiAoYWNrKSB7XG4gICAgICAgICAgICBtZXNzYWdlLmVycm9yID8gYWNrLmVycm9yKG1lc3NhZ2UuZXJyb3IpIDogYWNrLm9rKG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93c0luYm91bmRPdGhlcihtZXNzYWdlOiBPdGhlcikge1xuICAgICAgICB0aGlzLmVtaXQoYCR7bWVzc2FnZS50eXBlfWAsIG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3NNZXNzYWdlKGV2dCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdyYXc6aW5jb21taW5nJywgZXZ0LmRhdGEpO1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IDxJbmJvdW5kPkpTT04ucGFyc2UoZXZ0LmRhdGEpO1xuICAgICAgICAgICAgZGVidWcoJ3JlY2VpdmU9JywgbWVzc2FnZSk7ICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAobWVzc2FnZS50eXBlID09PSAnZXJyb3InKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fd3NJbmJvdW5kRXJyb3IoPEVycm9yPm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlLnR5cGUgPT09ICdhY2snKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fd3NJbmJvdW5kQWNrKDxBY2s+bWVzc2FnZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX3dzSW5ib3VuZE90aGVyKDxPdGhlcj5tZXNzYWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3Byb3RvY29sOmVycm9yJywgZXJyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3NFcnJvcihldnQpIHtcbiAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnQ6ZXJyb3InLCBldnQpO1xuICAgICAgICB0aGlzLl93c0Rpc2Nvbm5lY3QodGhpcy5fc29ja2V0LCBldnQpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3NDbG9zZShldnQpIHtcbiAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnQ6Y2xvc2UnLCBldnQpO1xuICAgICAgICB0aGlzLl93c0Rpc2Nvbm5lY3QodGhpcy5fc29ja2V0LCBldnQpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3NTZW5kKG1lc3NhZ2U6IE91dGJvdW5kLCB0aW1lb3V0OiBudW1iZXIgPSB0aGlzLnRpbWVvdXQpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0dXMgPCBDb25uZWN0aW9uU3RhdHVzLkNvbm5lY3RlZCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBNZXNzYWdlU2VuZEVycm9yKCdDYW5ub3Qgc2VuZCBkYXRhIGFjcm9zcyBhIHNvY2tldCB0aGF0IGlzIG5vdCBjb25uZWN0ZWQuJywgTWVzc2FnZVNlbmRFcnJvckNhdXNlLk5vQXV0aCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVidWcoJ3NlbmQ9JywgbWVzc2FnZSk7XG5cbiAgICAgICAgdmFyIGRhdGE7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYXRhID0gSlNPTi5zdHJpbmdpZnkobWVzc2FnZSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdwcm90b2NvbDplcnJvcicsIGVycik7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0NvdWxkIG5vdCBzZXJpYWxpemUgbWVzc2FnZS4nLCBNZXNzYWdlU2VuZEVycm9yQ2F1c2UuU2VyaWFsaXphdGlvbiwgZXJyLCBtZXNzYWdlKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmVtaXQoJ3JhdzpvdXRnb2luZycsIGRhdGEpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzb2NrZXQgPSB0aGlzLl9zb2NrZXQ7XG4gICAgICAgICAgICBzb2NrZXQuc2VuZChkYXRhKTsgICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoc29ja2V0ICE9PSB0aGlzLl9zb2NrZXQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCB3YXMgZGVzdHJveWVkIGR1cmluZyBzZW5kLicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGRlYnVnKCdzZW5kIGVycj0nLCBlcnIpO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnQ6ZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBNZXNzYWdlU2VuZEVycm9yKCdBbiBlcnJvciBvY2N1cnJlZCBpbiB0aGUgdHJhbnNwb3J0LicsIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZS5UcmFuc3BvcnQsIGVyciwgbWVzc2FnZSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG1lc3NhZ2UuaWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gbWVzc2FnZS5pZDtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLl9uZWVkc0Fja1tpZF0gPSA8UGVuZGluZ0Fja0NvbnRleHQ+e2lkOmlkfTtcbiAgICAgICAgICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgob2ssIGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnRleHQub2sgPSBvaztcbiAgICAgICAgICAgICAgICBjb250ZXh0LmVycm9yID0gZXJyO1xuICAgICAgICAgICAgfSk7ICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgZGVidWcoJ2FjayB0aW1lb3V0PScsIHRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIGNvbnRleHQuZXJyb3IobmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0RpZCBub3QgcmVjZWl2ZSBhY2tub3dsZWRnZW1lbnQgaW4gdGhlIHRpbWVvdXQgcGVyaW9kLicsIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZS5Ob0Fjaywgdm9pZCAwLCBtZXNzYWdlKSlcbiAgICAgICAgICAgIH0sIHRpbWVvdXQpO1xuICAgICAgICAgICAgY29uc3QgY2xlYW51cCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9uZWVkc0Fja1tpZF07XG4gICAgICAgICAgICB9OyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbigoYWNrOkFjaykgPT4ge1xuICAgICAgICAgICAgICAgIGRlYnVnKCdhY2s9JywgYWNrKTtcbiAgICAgICAgICAgICAgICBjbGVhbnVwKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjaztcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBkZWJ1ZygnYWNrIGVycm9yPScsIGVycik7XG4gICAgICAgICAgICAgICAgY2xlYW51cCgpO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBNZXNzYWdlU2VuZEVycm9yKCdBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgcHJvbWlzZSByZXNvbHV0aW9uJywgTWVzc2FnZVNlbmRFcnJvckNhdXNlLlByb21pc2UsIGVyciwgbWVzc2FnZSk7XG4gICAgICAgICAgICB9KTsgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2VuZChtZXNzYWdlOiBPdXRib3VuZCk6IFByb21pc2U8QWNrPiB7XG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyA8IENvbm5lY3Rpb25TdGF0dXMuQXV0aGVudGljYXRlZCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBNZXNzYWdlU2VuZEVycm9yKCdDYW5ub3Qgc2VuZCBkYXRhIGFjcm9zcyBhIHNvY2tldCB0aGF0IGlzIG5vdCBhdXRoZW50aWNhdGVkLicsIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZS5Ob0F1dGgsIHZvaWQgMCwgbWVzc2FnZSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl93c1NlbmQobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgX2Vuc3VyZUNhbkFjayhhY2s6IGJvb2xlYW4sIG1lc3NhZ2U6IE91dGJvdW5kKTogT3V0Ym91bmQge1xuICAgICAgICBpZiAoYWNrICYmICEoJ2lkJyBpbiBtZXNzYWdlKSkgeyBtZXNzYWdlLmlkID0gdGhpcy5uZXh0SWQoKTsgfVxuICAgICAgICByZXR1cm4gbWVzc2FnZTtcbiAgICB9XG5cbiAgICBzZW5kUGluZyhtZXNzYWdlOiBQaW5nID0gPFBpbmc+e30sIGFjazogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBtZXNzYWdlLnR5cGUgPSAncGluZyc7XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQodGhpcy5fZW5zdXJlQ2FuQWNrKGFjaywgbWVzc2FnZSkpO1xuICAgIH1cblxuICAgIHNlbmRDaGF0KG1lc3NhZ2U6IENoYXQsIGFjazogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBtZXNzYWdlLnR5cGUgPSAnY2hhdCc7XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQodGhpcy5fZW5zdXJlQ2FuQWNrKGFjaywgbWVzc2FnZSkpO1xuICAgIH1cblxuICAgIHNlbmRQcmVzZW5jZUNoYW5nZShtZXNzYWdlOiBQcmVzZW5jZUNoYW5nZSwgYWNrOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBtZXNzYWdlLnR5cGUgPSAncHJlc2VuY2VfY2hhbmdlJztcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgc2VuZFVzZXJUeXBpbmcobWVzc2FnZTogVXNlclR5cGluZywgYWNrOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBtZXNzYWdlLnR5cGUgPSAndXNlcl90eXBpbmcnO1xuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKHRoaXMuX2Vuc3VyZUNhbkFjayhhY2ssIG1lc3NhZ2UpKTtcbiAgICB9XG5cbiAgICBzZW5kVGVhbUpvaW4obWVzc2FnZTogVGVhbUpvaW4sIGFjazogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxBY2s+IHtcbiAgICAgICAgbWVzc2FnZS50eXBlID0gJ3RlYW1fam9pbic7XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQodGhpcy5fZW5zdXJlQ2FuQWNrKGFjaywgbWVzc2FnZSkpO1xuICAgIH1cblxuICAgIHNlbmRUZWFtTGVhdmUobWVzc2FnZTogVGVhbUxlYXZlLCBhY2s6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8QWNrPiB7XG4gICAgICAgIG1lc3NhZ2UudHlwZSA9ICd0ZWFtX2xlYXZlJztcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XG4gICAgfVxufVxuIl19