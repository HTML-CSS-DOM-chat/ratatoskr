"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var events_1 = require('events');
var defer_1 = require('./defer');
var WebSocket = require('ws');
var shortid = require('shortid');
var debug = require('debug')('ratatoskr:client');
(function (ConnectionStatus) {
    ConnectionStatus[ConnectionStatus["Disconnected"] = 0] = "Disconnected";
    ConnectionStatus[ConnectionStatus["Connecting"] = 1] = "Connecting";
    ConnectionStatus[ConnectionStatus["Connected"] = 2] = "Connected";
    ConnectionStatus[ConnectionStatus["Authenticated"] = 3] = "Authenticated";
})(exports.ConnectionStatus || (exports.ConnectionStatus = {}));
var ConnectionStatus = exports.ConnectionStatus;
(function (MessageSendErrorCause) {
    MessageSendErrorCause[MessageSendErrorCause["NoConnection"] = 0] = "NoConnection";
    MessageSendErrorCause[MessageSendErrorCause["NoAuth"] = 1] = "NoAuth";
    MessageSendErrorCause[MessageSendErrorCause["NoAck"] = 2] = "NoAck";
    MessageSendErrorCause[MessageSendErrorCause["Serialization"] = 3] = "Serialization";
    MessageSendErrorCause[MessageSendErrorCause["Transport"] = 4] = "Transport";
    MessageSendErrorCause[MessageSendErrorCause["Promise"] = 5] = "Promise";
})(exports.MessageSendErrorCause || (exports.MessageSendErrorCause = {}));
var MessageSendErrorCause = exports.MessageSendErrorCause;
var MessageSendError = (function (_super) {
    __extends(MessageSendError, _super);
    function MessageSendError(message, cause, source, data) {
        _super.call(this, message);
        this.cause = cause;
        this.source = source;
        this.data = data;
    }
    return MessageSendError;
}(Error));
exports.MessageSendError = MessageSendError;
var Client = (function (_super) {
    __extends(Client, _super);
    function Client(_a) {
        var _this = this;
        var _b = _a === void 0 ? {} : _a, endpoint = _b.endpoint, authorization = _b.authorization, _c = _b.timeout, timeout = _c === void 0 ? 5 * 1000 : _c, _d = _b.resource, resource = _d === void 0 ? '' : _d, _e = _b.agent, agent = _e === void 0 ? 'Ratatoskr' : _e, _f = _b.extensions, extensions = _f === void 0 ? [] : _f;
        _super.call(this);
        this.status = ConnectionStatus.Disconnected;
        this.timeout = 5 * 1000;
        this._needsAck = {};
        this.agent = agent;
        this.resource = resource;
        this.endpoint = endpoint;
        this.authorization = authorization;
        this.timeout = timeout;
        extensions.forEach(function (ext) { return _this.use(ext); });
    }
    Client.prototype.use = function (ext) {
        if (typeof ext.prototype.init === 'function') {
            (new ext()).init(this);
        }
        else if (typeof ext.init === 'function') {
            ext.init(this);
        }
        else if (typeof ext === 'function') {
            ext(this);
        }
    };
    Client.prototype.nextId = function () {
        return shortid.generate();
    };
    Client.prototype.connect = function () {
        var _this = this;
        if (this.status !== ConnectionStatus.Disconnected) {
            return;
        }
        this.status = ConnectionStatus.Connecting;
        debug('connect endpoint=', this.endpoint);
        this.emit('connecting');
        var socket = new WebSocket(this.endpoint, ['ratatoskr']);
        socket.onopen = function (evt) {
            debug('connect onopen=', evt);
            _this._wsBind(socket);
        };
        socket.onerror = function (evt) {
            debug('connect onerror=', evt);
            _this.emit('transport:error', evt);
            _this._wsDisconnect(socket, evt);
        };
        socket.onclose = function (evt) {
            debug('connect onclose=', evt);
            _this.emit('transport:close', evt);
            _this._wsDisconnect(socket, evt);
        };
    };
    Client.prototype.disconnect = function (reason) {
        if (reason === void 0) { reason = this; }
        this._wsDisconnect(this._socket, reason);
    };
    Client.prototype._wsDisconnect = function (socket, reason) {
        var _this = this;
        debug('disconnect reason=', reason);
        try {
            if (socket) {
                socket.onopen = null;
                socket.onerror = null;
                socket.onmessage = null;
                socket.onclose = null;
                socket.close();
            }
        }
        catch (err) {
        }
        finally {
            this._socket = null;
        }
        Object.keys(this._needsAck).forEach(function (k) {
            _this._needsAck[k].deferred.reject(reason);
        }), this._needsAck = {};
        this.status = ConnectionStatus.Disconnected;
        this.emit('disconnected', reason);
    };
    Client.prototype._wsBind = function (socket) {
        var _this = this;
        socket.onopen = null;
        socket.onerror = this._wsError.bind(this);
        socket.onmessage = this._wsMessage.bind(this);
        socket.onclose = this._wsClose.bind(this);
        this._socket = socket;
        this.status = ConnectionStatus.Connected;
        this.emit('connected');
        var auth;
        auth = typeof this.authorization === 'function' ? this.authorization() : this.authorization;
        var message = {
            id: this.nextId(),
            type: 'auth',
            authorization: auth
        };
        if (this.agent)
            message.agent = this.agent;
        if (this.resource)
            message.resource = this.resource;
        this._wsSend(message).then(function (ack) {
            debug('authentication ack=', ack);
            _this.status = ConnectionStatus.Authenticated;
            _this.emit('authenticated', ack);
        }, function (err) {
            debug('authentication error=', err);
            _this.emit('protocol:error', err);
            _this._wsDisconnect(_this._socket, err);
        });
    };
    Client.prototype._wsMessage = function (evt) {
        try {
            this.emit('raw:incomming', evt.data);
            var message = JSON.parse(evt.data);
            if (message.type === 'error') {
                if (message.code === 'auth_failed') {
                    debug('authentication failure=', message);
                    this._wsDisconnect(this._socket, message);
                }
                else {
                    this.emit('protocol:error', message);
                }
            }
            else if (message.type === 'ack') {
                var id = message.reply_to;
                if (this._needsAck[id]) {
                    this._needsAck[id].deferred.resolve(message);
                }
            }
            else if (message.type) {
                this.emit("" + message.type, message);
            }
        }
        catch (err) {
            this.emit('protocol:error', err);
        }
    };
    Client.prototype._wsError = function (evt) {
        this.emit('transport:error', evt);
        this._wsDisconnect(this._socket, evt);
    };
    Client.prototype._wsClose = function (evt) {
        this.emit('transport:close', evt);
        this._wsDisconnect(this._socket, evt);
    };
    Client.prototype._wsSend = function (message, timeout) {
        var _this = this;
        if (timeout === void 0) { timeout = this.timeout; }
        if (this.status < ConnectionStatus.Connected) {
            return Promise.reject(new MessageSendError('Cannot send data across a socket that is not connected.', MessageSendErrorCause.NoAuth));
        }
        debug('send message=', message);
        var data;
        try {
            data = JSON.stringify(message);
        }
        catch (err) {
            this.emit('protocol:error', err);
            return Promise.reject(new MessageSendError('Could not serialize message.', MessageSendErrorCause.Serialization, err, message));
        }
        this.emit('raw:outgoing', data);
        try {
            var socket = this._socket;
            socket.send(data);
            if (socket !== this._socket) {
                throw new Error('Socket was destroyed during send.');
            }
        }
        catch (err) {
            debug('send exception=', err);
            this.emit('transport:error', err);
            return Promise.reject(new MessageSendError('An error occurred in the transport.', MessageSendErrorCause.Transport, err, message));
        }
        if (message.id) {
            var id = message.id;
            var deferred = defer_1.default();
            var pending = this._needsAck[id] = {
                id: id,
                message: message,
                deferred: deferred,
                timeout: setTimeout(function () {
                    debug('send timeout');
                    deferred.reject(new MessageSendError('Did not receive acknowledgement in the timeout period.', MessageSendErrorCause.NoAck, void 0, message));
                }, timeout)
            };
            var cleanup = function () {
                clearTimeout(pending.timeout);
                delete _this._needsAck[id];
            };
            return deferred.promise.then(function (ack) {
                debug('send ack=', ack);
                cleanup();
                return ack;
            }, function (err) {
                debug('send error=', err);
                cleanup();
                throw new MessageSendError('An error occurred during promise resolution', MessageSendErrorCause.Promise, err, message);
            });
        }
        else {
            return Promise.resolve();
        }
    };
    Client.prototype.send = function (message) {
        if (this.status < ConnectionStatus.Authenticated) {
            return Promise.reject(new MessageSendError('Cannot send data across a socket that is not authenticated.', MessageSendErrorCause.NoAuth, void 0, message));
        }
        return this._wsSend(message);
    };
    Client.prototype._ensureCanAck = function (ack, message) {
        if (ack && !('id' in message)) {
            message.id = this.nextId();
        }
        return message;
    };
    Client.prototype.sendPing = function (message, ack) {
        if (message === void 0) { message = {}; }
        if (ack === void 0) { ack = true; }
        message.type = 'ping';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendChat = function (message, ack) {
        if (ack === void 0) { ack = true; }
        message.type = 'chat';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendPresenceChange = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'presence_change';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendUserTyping = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'user_typing';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendTeamJoin = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'team_join';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendTeamLeave = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'team_leave';
        return this.send(this._ensureCanAck(ack, message));
    };
    return Client;
}(events_1.EventEmitter));
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSx1QkFBMkIsUUFBUSxDQUFDLENBQUE7QUFFcEMsc0JBQThCLFNBQVMsQ0FBQyxDQUFBO0FBQ3hDLElBQVksU0FBUyxXQUFNLElBQUksQ0FBQyxDQUFBO0FBQ2hDLElBQVksT0FBTyxXQUFNLFNBQVMsQ0FBQyxDQUFBO0FBR25DLElBQU0sS0FBSyxHQUFpQixPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUVqRSxXQUFZLGdCQUFnQjtJQUN4Qix1RUFBZ0IsQ0FBQTtJQUNoQixtRUFBYyxDQUFBO0lBQ2QsaUVBQWEsQ0FBQTtJQUNiLHlFQUFpQixDQUFBO0FBQ3JCLENBQUMsRUFMVyx3QkFBZ0IsS0FBaEIsd0JBQWdCLFFBSzNCO0FBTEQsSUFBWSxnQkFBZ0IsR0FBaEIsd0JBS1gsQ0FBQTtBQStCRCxXQUFZLHFCQUFxQjtJQUM3QixpRkFBZ0IsQ0FBQTtJQUNoQixxRUFBVSxDQUFBO0lBQ1YsbUVBQVMsQ0FBQTtJQUNULG1GQUFpQixDQUFBO0lBQ2pCLDJFQUFhLENBQUE7SUFDYix1RUFBVyxDQUFBO0FBQ2YsQ0FBQyxFQVBXLDZCQUFxQixLQUFyQiw2QkFBcUIsUUFPaEM7QUFQRCxJQUFZLHFCQUFxQixHQUFyQiw2QkFPWCxDQUFBO0FBRUQ7SUFBc0Msb0NBQUs7SUFLdkMsMEJBQVksT0FBZSxFQUFFLEtBQTRCLEVBQUUsTUFBWSxFQUFFLElBQWM7UUFDbkYsa0JBQU0sT0FBTyxDQUFDLENBQUM7UUFFZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBQ0wsdUJBQUM7QUFBRCxDQUFDLEFBWkQsQ0FBc0MsS0FB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bUJBQW9CLEdBQXBCLFdBQW9CO1FBQ3ZELE9BQU8sQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVELDhCQUFhLEdBQWIsVUFBYyxPQUF5QixFQUFFLEdBQW9CO1FBQXBCLG1CQUFvQixHQUFwQixXQUFvQjtRQUN6RCxPQUFPLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQztRQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFDTCxhQUFDO0FBQUQsQ0FBQyxBQXBSRCxDQUE0QixxQkFBWSxHQW9SdkM7QUFwUlksY0FBTSxTQW9SbEIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL2luZGV4LmQudHNcIiAvPlxuXG5pbXBvcnQge0V2ZW50RW1pdHRlcn0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCAqIGFzIHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IGRlZmVyLCB7RGVmZXJyZWR9IGZyb20gJy4vZGVmZXInO1xuaW1wb3J0ICogYXMgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCAqIGFzIHNob3J0aWQgZnJvbSAnc2hvcnRpZCc7XG5pbXBvcnQge01lc3NhZ2UsIEF1dGhNZXNzYWdlLCBDaGF0TWVzc2FnZSwgUHJlc2VuY2VDaGFuZ2VNZXNzYWdlLCBVc2VyVHlwaW5nTWVzc2FnZSwgQWNrLCBQaW5nTWVzc2FnZSwgVGVhbUpvaW5NZXNzYWdlLCBUZWFtTGVhdmVNZXNzYWdlfSBmcm9tICcuL2ludGVyZmFjZXMuZCc7XG5cbmNvbnN0IGRlYnVnOiBEZWJ1Zy5Mb2dnZXIgPSByZXF1aXJlKCdkZWJ1ZycpKCdyYXRhdG9za3I6Y2xpZW50Jyk7XG5cbmV4cG9ydCBlbnVtIENvbm5lY3Rpb25TdGF0dXMge1xuICAgIERpc2Nvbm5lY3RlZCA9IDAsXG4gICAgQ29ubmVjdGluZyA9IDEsXG4gICAgQ29ubmVjdGVkID0gMixcbiAgICBBdXRoZW50aWNhdGVkID0gM1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3Rpb25PcHRpb25zIHtcbiAgICBlbmRwb2ludD86IHN0cmluZztcbiAgICBhdXRob3JpemF0aW9uPzogc3RyaW5nIHwgQXV0aG9yaXphdGlvbkZ1bmM7XG4gICAgcmVzb3VyY2U/OiBzdHJpbmc7XG4gICAgYWdlbnQ/OiBzdHJpbmc7XG4gICAgdGltZW91dD86IG51bWJlcjtcbiAgICBleHRlbnNpb25zPzogYW55W107XG59XG5cblxuZXhwb3J0IGludGVyZmFjZSBQZW5kaW5nQWNrQ29udGV4dCB7XG4gICAgaWQ6IHN0cmluZztcbiAgICBtZXNzYWdlOiBhbnk7XG4gICAgZGVmZXJyZWQ6IERlZmVycmVkO1xuICAgIHRpbWVvdXQ6IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRob3JpemF0aW9uRnVuYyB7XG4gICAgKCk6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb24ge1xuICAgIGluaXQoY2xpZW50OiBDbGllbnQpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVuc2lvbkFzRnVuYyB7XG4gICAgKGNsaWVudDogQ2xpZW50KTogdm9pZDtcbn1cblxuZXhwb3J0IGVudW0gTWVzc2FnZVNlbmRFcnJvckNhdXNlIHtcbiAgICBOb0Nvbm5lY3Rpb24gPSAwLFxuICAgIE5vQXV0aCA9IDEsXG4gICAgTm9BY2sgPSAyLFxuICAgIFNlcmlhbGl6YXRpb24gPSAzLFxuICAgIFRyYW5zcG9ydCA9IDQsXG4gICAgUHJvbWlzZSA9IDVcbn1cblxuZXhwb3J0IGNsYXNzIE1lc3NhZ2VTZW5kRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gICAgZGF0YTogTWVzc2FnZTtcbiAgICBjYXVzZTogTWVzc2FnZVNlbmRFcnJvckNhdXNlO1xuICAgIHNvdXJjZTogYW55O1xuXG4gICAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nLCBjYXVzZTogTWVzc2FnZVNlbmRFcnJvckNhdXNlLCBzb3VyY2U/OiBhbnksIGRhdGE/OiBNZXNzYWdlKSB7XG4gICAgICAgIHN1cGVyKG1lc3NhZ2UpO1xuXG4gICAgICAgIHRoaXMuY2F1c2UgPSBjYXVzZTtcbiAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7XG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgfVxufVxuXG4vKipcbiAqL1xuZXhwb3J0IGNsYXNzIENsaWVudCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgc3RhdHVzOiBDb25uZWN0aW9uU3RhdHVzID0gQ29ubmVjdGlvblN0YXR1cy5EaXNjb25uZWN0ZWQ7XG4gICAgcmVzb3VyY2U6IHN0cmluZztcbiAgICBhZ2VudDogc3RyaW5nO1xuICAgIGVuZHBvaW50OiBzdHJpbmc7XG4gICAgYXV0aG9yaXphdGlvbjogc3RyaW5nIHwgQXV0aG9yaXphdGlvbkZ1bmM7XG4gICAgdGltZW91dDogbnVtYmVyID0gNSAqIDEwMDA7XG5cbiAgICBwcm90ZWN0ZWQgX3NvY2tldDogV2ViU29ja2V0O1xuICAgIHByb3RlY3RlZCBfbmVlZHNBY2s6IHtbaWQ6c3RyaW5nXTpQZW5kaW5nQWNrQ29udGV4dH0gPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKHtlbmRwb2ludCwgYXV0aG9yaXphdGlvbiwgdGltZW91dCA9IDUgKiAxMDAwLCByZXNvdXJjZSA9ICcnLCBhZ2VudCA9ICdSYXRhdG9za3InLCBleHRlbnNpb25zID0gW119OiBDb25uZWN0aW9uT3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5hZ2VudCA9IGFnZW50O1xuICAgICAgICB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7XG4gICAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludDtcbiAgICAgICAgdGhpcy5hdXRob3JpemF0aW9uID0gYXV0aG9yaXphdGlvbjtcbiAgICAgICAgdGhpcy50aW1lb3V0ID0gdGltZW91dDtcblxuICAgICAgICBleHRlbnNpb25zLmZvckVhY2goKGV4dCkgPT4gdGhpcy51c2UoZXh0KSk7XG4gICAgfVxuXG4gICAgdXNlKGV4dDogRXh0ZW5zaW9uKTtcbiAgICB1c2UoZXh0OiBFeHRlbnNpb25Bc0Z1bmMpO1xuICAgIHVzZShleHQ6IGFueSkge1xuICAgICAgICBpZiAodHlwZW9mIGV4dC5wcm90b3R5cGUuaW5pdCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgKG5ldyBleHQoKSkuaW5pdCh0aGlzKTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXh0LmluaXQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGV4dC5pbml0KHRoaXMpO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGV4dCh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5leHRJZCgpIHtcbiAgICAgICAgcmV0dXJuIHNob3J0aWQuZ2VuZXJhdGUoKTtcbiAgICB9XG5cbiAgICBjb25uZWN0KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5zdGF0dXMgIT09IENvbm5lY3Rpb25TdGF0dXMuRGlzY29ubmVjdGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnN0YXR1cyA9IENvbm5lY3Rpb25TdGF0dXMuQ29ubmVjdGluZztcblxuICAgICAgICBkZWJ1ZygnY29ubmVjdCBlbmRwb2ludD0nLCB0aGlzLmVuZHBvaW50KTtcblxuICAgICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3RpbmcnKTtcblxuICAgICAgICB2YXIgc29ja2V0ID0gbmV3IFdlYlNvY2tldCh0aGlzLmVuZHBvaW50LCBbJ3JhdGF0b3NrciddKTtcblxuICAgICAgICBzb2NrZXQub25vcGVuID0gKGV2dCkgPT4ge1xuICAgICAgICAgICAgZGVidWcoJ2Nvbm5lY3Qgb25vcGVuPScsIGV2dCk7XG5cbiAgICAgICAgICAgIHRoaXMuX3dzQmluZChzb2NrZXQpO1xuICAgICAgICB9O1xuICAgICAgICBzb2NrZXQub25lcnJvciA9IChldnQpID0+IHtcbiAgICAgICAgICAgIGRlYnVnKCdjb25uZWN0IG9uZXJyb3I9JywgZXZ0KTtcblxuICAgICAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnQ6ZXJyb3InLCBldnQpO1xuICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHNvY2tldCwgZXZ0KTtcbiAgICAgICAgfTtcbiAgICAgICAgc29ja2V0Lm9uY2xvc2UgPSAoZXZ0KSA9PiB7XG4gICAgICAgICAgICBkZWJ1ZygnY29ubmVjdCBvbmNsb3NlPScsIGV2dCk7XG5cbiAgICAgICAgICAgIHRoaXMuZW1pdCgndHJhbnNwb3J0OmNsb3NlJywgZXZ0KTtcbiAgICAgICAgICAgIHRoaXMuX3dzRGlzY29ubmVjdChzb2NrZXQsIGV2dCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkaXNjb25uZWN0KHJlYXNvbjogYW55ID0gdGhpcyk6IHZvaWQge1xuICAgICAgICB0aGlzLl93c0Rpc2Nvbm5lY3QodGhpcy5fc29ja2V0LCByZWFzb24pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfd3NEaXNjb25uZWN0KHNvY2tldDogV2ViU29ja2V0LCByZWFzb24/OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgZGVidWcoJ2Rpc2Nvbm5lY3QgcmVhc29uPScsIHJlYXNvbik7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChzb2NrZXQpIHtcbiAgICAgICAgICAgICAgICBzb2NrZXQub25vcGVuID0gbnVsbDtcbiAgICAgICAgICAgICAgICBzb2NrZXQub25lcnJvciA9IG51bGw7XG4gICAgICAgICAgICAgICAgc29ja2V0Lm9ubWVzc2FnZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgc29ja2V0Lm9uY2xvc2UgPSBudWxsO1xuICAgICAgICAgICAgICAgIHNvY2tldC5jbG9zZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIC8vIG5vdGhpbmcgdG8gZG8gaGVyZSwgd2UgYXJlIHJlbGVhc2luZyB0aGUgc29ja2V0XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICB0aGlzLl9zb2NrZXQgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5fbmVlZHNBY2spLmZvckVhY2goKGspID0+IHtcbiAgICAgICAgICAgIHRoaXMuX25lZWRzQWNrW2tdLmRlZmVycmVkLnJlamVjdChyZWFzb24pO1xuICAgICAgICB9KSwgdGhpcy5fbmVlZHNBY2sgPSB7fTtcblxuICAgICAgICB0aGlzLnN0YXR1cyA9IENvbm5lY3Rpb25TdGF0dXMuRGlzY29ubmVjdGVkO1xuXG4gICAgICAgIHRoaXMuZW1pdCgnZGlzY29ubmVjdGVkJywgcmVhc29uKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3dzQmluZChzb2NrZXQ6IFdlYlNvY2tldCk6IHZvaWQge1xuICAgICAgICBzb2NrZXQub25vcGVuID0gbnVsbDtcbiAgICAgICAgc29ja2V0Lm9uZXJyb3IgPSB0aGlzLl93c0Vycm9yLmJpbmQodGhpcyk7XG4gICAgICAgIHNvY2tldC5vbm1lc3NhZ2UgPSB0aGlzLl93c01lc3NhZ2UuYmluZCh0aGlzKTtcbiAgICAgICAgc29ja2V0Lm9uY2xvc2UgPSB0aGlzLl93c0Nsb3NlLmJpbmQodGhpcyk7XG5cbiAgICAgICAgdGhpcy5fc29ja2V0ID0gc29ja2V0O1xuXG4gICAgICAgIHRoaXMuc3RhdHVzID0gQ29ubmVjdGlvblN0YXR1cy5Db25uZWN0ZWQ7XG5cbiAgICAgICAgdGhpcy5lbWl0KCdjb25uZWN0ZWQnKTtcblxuICAgICAgICB2YXIgYXV0aDogc3RyaW5nO1xuXG4gICAgICAgIGF1dGggPSB0eXBlb2YgdGhpcy5hdXRob3JpemF0aW9uID09PSAnZnVuY3Rpb24nID8gKDxBdXRob3JpemF0aW9uRnVuYz50aGlzLmF1dGhvcml6YXRpb24pKCkgOiA8c3RyaW5nPnRoaXMuYXV0aG9yaXphdGlvbjtcblxuICAgICAgICB2YXIgbWVzc2FnZSA9IDxBdXRoTWVzc2FnZT57XG4gICAgICAgICAgICBpZDogdGhpcy5uZXh0SWQoKSxcbiAgICAgICAgICAgIHR5cGU6ICdhdXRoJyxcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb246IGF1dGhcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodGhpcy5hZ2VudCkgbWVzc2FnZS5hZ2VudCA9IHRoaXMuYWdlbnQ7XG4gICAgICAgIGlmICh0aGlzLnJlc291cmNlKSBtZXNzYWdlLnJlc291cmNlID0gdGhpcy5yZXNvdXJjZTtcblxuICAgICAgICB0aGlzLl93c1NlbmQobWVzc2FnZSkudGhlbigoYWNrKSA9PiB7XG4gICAgICAgICAgICBkZWJ1ZygnYXV0aGVudGljYXRpb24gYWNrPScsIGFjayk7XG5cbiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gQ29ubmVjdGlvblN0YXR1cy5BdXRoZW50aWNhdGVkO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdhdXRoZW50aWNhdGVkJywgYWNrKTtcbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgZGVidWcoJ2F1dGhlbnRpY2F0aW9uIGVycm9yPScsIGVycik7XG5cbiAgICAgICAgICAgIHRoaXMuZW1pdCgncHJvdG9jb2w6ZXJyb3InLCBlcnIpO1xuICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgZXJyKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF93c01lc3NhZ2UoZXZ0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3JhdzppbmNvbW1pbmcnLCBldnQuZGF0YSk7XG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IEpTT04ucGFyc2UoZXZ0LmRhdGEpO1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ2Vycm9yJykge1xuICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmNvZGUgPT09ICdhdXRoX2ZhaWxlZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVidWcoJ2F1dGhlbnRpY2F0aW9uIGZhaWx1cmU9JywgbWVzc2FnZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgbWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdwcm90b2NvbDplcnJvcicsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS50eXBlID09PSAnYWNrJykge1xuICAgICAgICAgICAgICAgIHZhciBpZCA9IG1lc3NhZ2UucmVwbHlfdG87XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX25lZWRzQWNrW2lkXSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9uZWVkc0Fja1tpZF0uZGVmZXJyZWQucmVzb2x2ZShtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudHlwZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChgJHttZXNzYWdlLnR5cGV9YCwgbWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdwcm90b2NvbDplcnJvcicsIGVycik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3dzRXJyb3IoZXZ0KSB7XG4gICAgICAgIHRoaXMuZW1pdCgndHJhbnNwb3J0OmVycm9yJywgZXZ0KTtcbiAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgZXZ0KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3dzQ2xvc2UoZXZ0KSB7XG4gICAgICAgIHRoaXMuZW1pdCgndHJhbnNwb3J0OmNsb3NlJywgZXZ0KTtcbiAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgZXZ0KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3dzU2VuZChtZXNzYWdlOiBNZXNzYWdlLCB0aW1lb3V0OiBudW1iZXIgPSB0aGlzLnRpbWVvdXQpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0dXMgPCBDb25uZWN0aW9uU3RhdHVzLkNvbm5lY3RlZCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBNZXNzYWdlU2VuZEVycm9yKCdDYW5ub3Qgc2VuZCBkYXRhIGFjcm9zcyBhIHNvY2tldCB0aGF0IGlzIG5vdCBjb25uZWN0ZWQuJywgTWVzc2FnZVNlbmRFcnJvckNhdXNlLk5vQXV0aCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVidWcoJ3NlbmQgbWVzc2FnZT0nLCBtZXNzYWdlKTtcblxuICAgICAgICB2YXIgZGF0YTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRhdGEgPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3Byb3RvY29sOmVycm9yJywgZXJyKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgTWVzc2FnZVNlbmRFcnJvcignQ291bGQgbm90IHNlcmlhbGl6ZSBtZXNzYWdlLicsIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZS5TZXJpYWxpemF0aW9uLCBlcnIsIG1lc3NhZ2UpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZW1pdCgncmF3Om91dGdvaW5nJywgZGF0YSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNvY2tldCA9IHRoaXMuX3NvY2tldDtcbiAgICAgICAgICAgIHNvY2tldC5zZW5kKGRhdGEpO1xuICAgICAgICAgICAgaWYgKHNvY2tldCAhPT0gdGhpcy5fc29ja2V0KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgd2FzIGRlc3Ryb3llZCBkdXJpbmcgc2VuZC4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBkZWJ1Zygnc2VuZCBleGNlcHRpb249JywgZXJyKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgndHJhbnNwb3J0OmVycm9yJywgZXJyKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgTWVzc2FnZVNlbmRFcnJvcignQW4gZXJyb3Igb2NjdXJyZWQgaW4gdGhlIHRyYW5zcG9ydC4nLCBNZXNzYWdlU2VuZEVycm9yQ2F1c2UuVHJhbnNwb3J0LCBlcnIsIG1lc3NhZ2UpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXNzYWdlLmlkKSB7XG4gICAgICAgICAgICB2YXIgaWQgPSBtZXNzYWdlLmlkO1xuICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKTtcbiAgICAgICAgICAgIHZhciBwZW5kaW5nID0gdGhpcy5fbmVlZHNBY2tbaWRdID0ge1xuICAgICAgICAgICAgICAgIGlkOiBpZCxcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgICAgICAgICAgIGRlZmVycmVkOiBkZWZlcnJlZCxcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZGVidWcoJ3NlbmQgdGltZW91dCcpO1xuICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0RpZCBub3QgcmVjZWl2ZSBhY2tub3dsZWRnZW1lbnQgaW4gdGhlIHRpbWVvdXQgcGVyaW9kLicsIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZS5Ob0Fjaywgdm9pZCAwLCBtZXNzYWdlKSlcbiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBjbGVhbnVwID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChwZW5kaW5nLnRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9uZWVkc0Fja1tpZF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZS50aGVuKChhY2spID0+IHtcbiAgICAgICAgICAgICAgICBkZWJ1Zygnc2VuZCBhY2s9JywgYWNrKTtcblxuICAgICAgICAgICAgICAgIGNsZWFudXAoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYWNrO1xuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGRlYnVnKCdzZW5kIGVycm9yPScsIGVycik7XG5cbiAgICAgICAgICAgICAgICBjbGVhbnVwKCk7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0FuIGVycm9yIG9jY3VycmVkIGR1cmluZyBwcm9taXNlIHJlc29sdXRpb24nLCBNZXNzYWdlU2VuZEVycm9yQ2F1c2UuUHJvbWlzZSwgZXJyLCBtZXNzYWdlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2VuZChtZXNzYWdlOiBNZXNzYWdlKTogUHJvbWlzZTxBY2s+IHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdHVzIDwgQ29ubmVjdGlvblN0YXR1cy5BdXRoZW50aWNhdGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0Nhbm5vdCBzZW5kIGRhdGEgYWNyb3NzIGEgc29ja2V0IHRoYXQgaXMgbm90IGF1dGhlbnRpY2F0ZWQuJywgTWVzc2FnZVNlbmRFcnJvckNhdXNlLk5vQXV0aCwgdm9pZCAwLCBtZXNzYWdlKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX3dzU2VuZChtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBfZW5zdXJlQ2FuQWNrKGFjazogYm9vbGVhbiwgbWVzc2FnZTogTWVzc2FnZSk6IE1lc3NhZ2Uge1xuICAgICAgICBpZiAoYWNrICYmICEoJ2lkJyBpbiBtZXNzYWdlKSkgeyBtZXNzYWdlLmlkID0gdGhpcy5uZXh0SWQoKTsgfVxuICAgICAgICByZXR1cm4gbWVzc2FnZTtcbiAgICB9XG5cbiAgICBzZW5kUGluZyhtZXNzYWdlOiBQaW5nTWVzc2FnZSA9IHt9LCBhY2s6IGJvb2xlYW4gPSB0cnVlKTogUHJvbWlzZTxBY2s+IHtcbiAgICAgICAgbWVzc2FnZS50eXBlID0gJ3BpbmcnO1xuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKHRoaXMuX2Vuc3VyZUNhbkFjayhhY2ssIG1lc3NhZ2UpKTtcbiAgICB9XG5cbiAgICBzZW5kQ2hhdChtZXNzYWdlOiBDaGF0TWVzc2FnZSwgYWNrOiBib29sZWFuID0gdHJ1ZSk6IFByb21pc2U8QWNrPiB7XG4gICAgICAgIG1lc3NhZ2UudHlwZSA9ICdjaGF0JztcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgc2VuZFByZXNlbmNlQ2hhbmdlKG1lc3NhZ2U6IFByZXNlbmNlQ2hhbmdlTWVzc2FnZSwgYWNrOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBtZXNzYWdlLnR5cGUgPSAncHJlc2VuY2VfY2hhbmdlJztcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgc2VuZFVzZXJUeXBpbmcobWVzc2FnZTogVXNlclR5cGluZ01lc3NhZ2UsIGFjazogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxBY2s+IHtcbiAgICAgICAgbWVzc2FnZS50eXBlID0gJ3VzZXJfdHlwaW5nJztcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgc2VuZFRlYW1Kb2luKG1lc3NhZ2U6IFRlYW1Kb2luTWVzc2FnZSwgYWNrOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEFjaz4ge1xuICAgICAgICBtZXNzYWdlLnR5cGUgPSAndGVhbV9qb2luJztcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgc2VuZFRlYW1MZWF2ZShtZXNzYWdlOiBUZWFtTGVhdmVNZXNzYWdlLCBhY2s6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8QWNrPiB7XG4gICAgICAgIG1lc3NhZ2UudHlwZSA9ICd0ZWFtX2xlYXZlJztcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XG4gICAgfVxufVxuIl19