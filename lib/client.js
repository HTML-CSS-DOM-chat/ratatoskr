"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var events_1 = require('events');
var defer_1 = require('./defer');
var WebSocket = require('ws');
var shortid = require('shortid');
var debug = require('debug')('ratatoskr:client');
(function (ConnectionStatus) {
    ConnectionStatus[ConnectionStatus["Disconnected"] = 0] = "Disconnected";
    ConnectionStatus[ConnectionStatus["Connecting"] = 1] = "Connecting";
    ConnectionStatus[ConnectionStatus["Connected"] = 2] = "Connected";
    ConnectionStatus[ConnectionStatus["Authenticated"] = 3] = "Authenticated";
})(exports.ConnectionStatus || (exports.ConnectionStatus = {}));
var ConnectionStatus = exports.ConnectionStatus;
(function (MessageSendErrorCause) {
    MessageSendErrorCause[MessageSendErrorCause["NoConnection"] = 0] = "NoConnection";
    MessageSendErrorCause[MessageSendErrorCause["NoAuth"] = 1] = "NoAuth";
    MessageSendErrorCause[MessageSendErrorCause["NoAck"] = 2] = "NoAck";
    MessageSendErrorCause[MessageSendErrorCause["Serialization"] = 3] = "Serialization";
    MessageSendErrorCause[MessageSendErrorCause["Transport"] = 4] = "Transport";
    MessageSendErrorCause[MessageSendErrorCause["Promise"] = 5] = "Promise";
})(exports.MessageSendErrorCause || (exports.MessageSendErrorCause = {}));
var MessageSendErrorCause = exports.MessageSendErrorCause;
var MessageSendError = (function (_super) {
    __extends(MessageSendError, _super);
    function MessageSendError(message, cause, source, data) {
        _super.call(this, message);
        this.cause = cause;
        this.source = source;
        this.data = data;
    }
    return MessageSendError;
}(Error));
exports.MessageSendError = MessageSendError;
var Client = (function (_super) {
    __extends(Client, _super);
    function Client(_a) {
        var _this = this;
        var _b = _a === void 0 ? {} : _a, endpoint = _b.endpoint, authorization = _b.authorization, _c = _b.timeout, timeout = _c === void 0 ? 5 * 1000 : _c, _d = _b.resource, resource = _d === void 0 ? '' : _d, _e = _b.agent, agent = _e === void 0 ? 'Ratatoskr' : _e, _f = _b.extensions, extensions = _f === void 0 ? [] : _f;
        _super.call(this);
        this.status = ConnectionStatus.Disconnected;
        this.timeout = 5 * 1000;
        this._needsAck = {};
        this.agent = agent;
        this.resource = resource;
        this.endpoint = endpoint;
        this.authorization = authorization;
        this.timeout = timeout;
        extensions.forEach(function (ext) { return _this.use(ext); });
    }
    Client.prototype.use = function (ext) {
        if (typeof ext.prototype.init === 'function') {
            (new ext()).init(this);
        }
        else if (typeof ext.init === 'function') {
            ext.init(this);
        }
        else if (typeof ext === 'function') {
            ext(this);
        }
    };
    Client.prototype.nextId = function () {
        return shortid.generate();
    };
    Client.prototype.connect = function () {
        var _this = this;
        if (this.status !== ConnectionStatus.Disconnected) {
            return;
        }
        this.status = ConnectionStatus.Connecting;
        debug('connect endpoint=', this.endpoint);
        this.emit('connecting');
        var socket = new WebSocket(this.endpoint, ['ratatoskr']);
        socket.onopen = function (evt) {
            debug('connect onopen=', evt);
            _this._wsBind(socket);
        };
        socket.onerror = function (evt) {
            debug('connect onerror=', evt);
            _this.emit('transport:error', evt);
            _this._wsDisconnect(socket, evt);
        };
        socket.onclose = function (evt) {
            debug('connect onclose=', evt);
            _this.emit('transport:close', evt);
            _this._wsDisconnect(socket, evt);
        };
    };
    Client.prototype.disconnect = function (reason) {
        if (reason === void 0) { reason = this; }
        this._wsDisconnect(this._socket, reason);
    };
    Client.prototype._wsDisconnect = function (socket, reason) {
        var _this = this;
        debug('disconnect reason=', reason);
        try {
            if (socket) {
                socket.onopen = null;
                socket.onerror = null;
                socket.onmessage = null;
                socket.onclose = null;
                socket.close();
            }
        }
        catch (err) {
        }
        finally {
            this._socket = null;
        }
        Object.keys(this._needsAck).forEach(function (k) {
            _this._needsAck[k].deferred.reject(reason);
        }), this._needsAck = {};
        this.status = ConnectionStatus.Disconnected;
        this.emit('disconnected', reason);
    };
    Client.prototype._wsBind = function (socket) {
        var _this = this;
        socket.onopen = null;
        socket.onerror = this._wsError.bind(this);
        socket.onmessage = this._wsMessage.bind(this);
        socket.onclose = this._wsClose.bind(this);
        this._socket = socket;
        this.status = ConnectionStatus.Connected;
        this.emit('connected');
        var auth;
        auth = typeof this.authorization === 'function' ? this.authorization() : this.authorization;
        var message = {
            id: this.nextId(),
            type: 'auth',
            authorization: auth
        };
        if (this.agent)
            message.agent = this.agent;
        if (this.resource)
            message.resource = this.resource;
        this._wsSend(message).then(function (ack) {
            debug('authentication ack=', ack);
            _this.status = ConnectionStatus.Authenticated;
            _this.emit('authenticated', ack);
        }, function (err) {
            debug('authentication error=', err);
            _this.emit('protocol:error', err);
            _this._wsDisconnect(_this._socket, err);
        });
    };
    Client.prototype._wsMessage = function (evt) {
        try {
            this.emit('raw:incomming', evt.data);
            var message = JSON.parse(evt.data);
            if (message.type === 'error') {
                if (message.code === 'auth_failed') {
                    debug('authentication failure=', message);
                    this._wsDisconnect(this._socket, message);
                }
                else {
                    this.emit('protocol:error', message);
                }
            }
            else if (message.type === 'ack') {
                var id = message.reply_to;
                if (this._needsAck[id]) {
                    this._needsAck[id].deferred.resolve(message);
                }
            }
            else if (message.type) {
                this.emit("" + message.type, message);
            }
        }
        catch (err) {
            this.emit('protocol:error', err);
        }
    };
    Client.prototype._wsError = function (evt) {
        this.emit('transport:error', evt);
        this._wsDisconnect(this._socket, evt);
    };
    Client.prototype._wsClose = function (evt) {
        this.emit('transport:close', evt);
        this._wsDisconnect(this._socket, evt);
    };
    Client.prototype._wsSend = function (message, timeout) {
        var _this = this;
        if (timeout === void 0) { timeout = this.timeout; }
        if (this.status < ConnectionStatus.Connected) {
            return Promise.reject(new MessageSendError('Cannot send data across a socket that is not connected.', MessageSendErrorCause.NoAuth));
        }
        debug('send message=', message);
        var data;
        try {
            data = JSON.stringify(message);
        }
        catch (err) {
            this.emit('protocol:error', err);
            return Promise.reject(new MessageSendError('Could not serialize message.', MessageSendErrorCause.Serialization, err, message));
        }
        this.emit('raw:outgoing', data);
        try {
            var socket = this._socket;
            socket.send(data);
            if (socket !== this._socket) {
                throw new Error('Socket was destroyed during send.');
            }
        }
        catch (err) {
            debug('send exception=', err);
            this.emit('transport:error', err);
            return Promise.reject(new MessageSendError('An error occurred in the transport.', MessageSendErrorCause.Transport, err, message));
        }
        if (message.id) {
            var id = message.id;
            var deferred = defer_1.default();
            var pending = this._needsAck[id] = {
                id: id,
                message: message,
                deferred: deferred,
                timeout: setTimeout(function () {
                    debug('send timeout');
                    deferred.reject(new MessageSendError('Did not receive acknowledgement in the timeout period.', MessageSendErrorCause.NoAck, void 0, message));
                }, timeout)
            };
            var cleanup = function () {
                clearTimeout(pending.timeout);
                delete _this._needsAck[id];
            };
            return deferred.promise.then(function (ack) {
                debug('send ack=', ack);
                cleanup();
                return ack;
            }, function (err) {
                debug('send error=', err);
                cleanup();
                throw new MessageSendError('An error occurred during promise resolution', MessageSendErrorCause.Promise, err, message);
            });
        }
        else {
            return Promise.resolve();
        }
    };
    Client.prototype.send = function (message) {
        if (this.status < ConnectionStatus.Authenticated) {
            return Promise.reject(new MessageSendError('Cannot send data across a socket that is not authenticated.', MessageSendErrorCause.NoAuth, void 0, message));
        }
        return this._wsSend(message);
    };
    Client.prototype._ensureCanAck = function (ack, message) {
        if (ack && !('id' in message)) {
            message.id = this.nextId();
        }
        return message;
    };
    Client.prototype.sendPing = function (message, ack) {
        if (message === void 0) { message = {}; }
        if (ack === void 0) { ack = true; }
        message.type = 'ping';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendChat = function (message, ack) {
        if (ack === void 0) { ack = true; }
        message.type = 'chat';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendPresenceChange = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'presence_change';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendUserTyping = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'user_typing';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendTeamJoin = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'team_join';
        return this.send(this._ensureCanAck(ack, message));
    };
    Client.prototype.sendTeamLeave = function (message, ack) {
        if (ack === void 0) { ack = false; }
        message.type = 'team_leave';
        return this.send(this._ensureCanAck(ack, message));
    };
    return Client;
}(events_1.EventEmitter));
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSx1QkFBMkIsUUFBUSxDQUFDLENBQUE7QUFFcEMsc0JBQThCLFNBQVMsQ0FBQyxDQUFBO0FBQ3hDLElBQVksU0FBUyxXQUFNLElBQUksQ0FBQyxDQUFBO0FBQ2hDLElBQVksT0FBTyxXQUFNLFNBQVMsQ0FBQyxDQUFBO0FBR25DLElBQU0sS0FBSyxHQUFpQixPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUVqRSxXQUFZLGdCQUFnQjtJQUN4Qix1RUFBZ0IsQ0FBQTtJQUNoQixtRUFBYyxDQUFBO0lBQ2QsaUVBQWEsQ0FBQTtJQUNiLHlFQUFpQixDQUFBO0FBQ3JCLENBQUMsRUFMVyx3QkFBZ0IsS0FBaEIsd0JBQWdCLFFBSzNCO0FBTEQsSUFBWSxnQkFBZ0IsR0FBaEIsd0JBS1gsQ0FBQTtBQStCRCxXQUFZLHFCQUFxQjtJQUM3QixpRkFBZ0IsQ0FBQTtJQUNoQixxRUFBVSxDQUFBO0lBQ1YsbUVBQVMsQ0FBQTtJQUNULG1GQUFpQixDQUFBO0lBQ2pCLDJFQUFhLENBQUE7SUFDYix1RUFBVyxDQUFBO0FBQ2YsQ0FBQyxFQVBXLDZCQUFxQixLQUFyQiw2QkFBcUIsUUFPaEM7QUFQRCxJQUFZLHFCQUFxQixHQUFyQiw2QkFPWCxDQUFBO0FBRUQ7SUFBc0Msb0NBQUs7SUFLdkMsMEJBQVksT0FBZSxFQUFFLEtBQTRCLEVBQUUsTUFBWSxFQUFFLElBQWM7UUFDbkYsa0JBQU0sT0FBTyxDQUFDLENBQUM7UUFFZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBQ0wsdUJBQUM7QUFBRCxDQUFDLEFBWkQsQ0FBc0MsS0FB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bUJBQW9CLEdBQXBCLFdBQW9CO1FBQ3ZELE9BQU8sQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVELDhCQUFhLEdBQWIsVUFBYyxPQUF5QixFQUFFLEdBQW9CO1FBQXBCLG1CQUFvQixHQUFwQixXQUFvQjtRQUN6RCxPQUFPLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQztRQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFDTCxhQUFDO0FBQUQsQ0FBQyxBQXBSRCxDQUE0QixxQkFBWSxHQW9SdkM7QUFwUlksY0FBTSxTQW9SbEIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL2luZGV4LmQudHNcIiAvPlxyXG5cclxuaW1wb3J0IHtFdmVudEVtaXR0ZXJ9IGZyb20gJ2V2ZW50cyc7XHJcbmltcG9ydCAqIGFzIHVybCBmcm9tICd1cmwnO1xyXG5pbXBvcnQgZGVmZXIsIHtEZWZlcnJlZH0gZnJvbSAnLi9kZWZlcic7XHJcbmltcG9ydCAqIGFzIFdlYlNvY2tldCBmcm9tICd3cyc7XHJcbmltcG9ydCAqIGFzIHNob3J0aWQgZnJvbSAnc2hvcnRpZCc7XHJcbmltcG9ydCB7TWVzc2FnZSwgQXV0aE1lc3NhZ2UsIENoYXRNZXNzYWdlLCBQcmVzZW5jZUNoYW5nZU1lc3NhZ2UsIFVzZXJUeXBpbmdNZXNzYWdlLCBBY2ssIFBpbmdNZXNzYWdlLCBUZWFtSm9pbk1lc3NhZ2UsIFRlYW1MZWF2ZU1lc3NhZ2V9IGZyb20gJy4vaW50ZXJmYWNlcy5kJztcclxuXHJcbmNvbnN0IGRlYnVnOiBEZWJ1Zy5Mb2dnZXIgPSByZXF1aXJlKCdkZWJ1ZycpKCdyYXRhdG9za3I6Y2xpZW50Jyk7XHJcblxyXG5leHBvcnQgZW51bSBDb25uZWN0aW9uU3RhdHVzIHtcclxuICAgIERpc2Nvbm5lY3RlZCA9IDAsXHJcbiAgICBDb25uZWN0aW5nID0gMSxcclxuICAgIENvbm5lY3RlZCA9IDIsXHJcbiAgICBBdXRoZW50aWNhdGVkID0gM1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3Rpb25PcHRpb25zIHtcclxuICAgIGVuZHBvaW50Pzogc3RyaW5nO1xyXG4gICAgYXV0aG9yaXphdGlvbj86IHN0cmluZyB8IEF1dGhvcml6YXRpb25GdW5jO1xyXG4gICAgcmVzb3VyY2U/OiBzdHJpbmc7XHJcbiAgICBhZ2VudD86IHN0cmluZztcclxuICAgIHRpbWVvdXQ/OiBudW1iZXI7XHJcbiAgICBleHRlbnNpb25zPzogYW55W107XHJcbn1cclxuXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBlbmRpbmdBY2tDb250ZXh0IHtcclxuICAgIGlkOiBzdHJpbmc7XHJcbiAgICBtZXNzYWdlOiBhbnk7XHJcbiAgICBkZWZlcnJlZDogRGVmZXJyZWQ7XHJcbiAgICB0aW1lb3V0OiBhbnk7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQXV0aG9yaXphdGlvbkZ1bmMge1xyXG4gICAgKCk6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb24ge1xyXG4gICAgaW5pdChjbGllbnQ6IENsaWVudCk7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZW5zaW9uQXNGdW5jIHtcclxuICAgIChjbGllbnQ6IENsaWVudCk6IHZvaWQ7XHJcbn1cclxuXHJcbmV4cG9ydCBlbnVtIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZSB7XHJcbiAgICBOb0Nvbm5lY3Rpb24gPSAwLFxyXG4gICAgTm9BdXRoID0gMSxcclxuICAgIE5vQWNrID0gMixcclxuICAgIFNlcmlhbGl6YXRpb24gPSAzLFxyXG4gICAgVHJhbnNwb3J0ID0gNCxcclxuICAgIFByb21pc2UgPSA1XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBNZXNzYWdlU2VuZEVycm9yIGV4dGVuZHMgRXJyb3Ige1xyXG4gICAgZGF0YTogTWVzc2FnZTtcclxuICAgIGNhdXNlOiBNZXNzYWdlU2VuZEVycm9yQ2F1c2U7XHJcbiAgICBzb3VyY2U6IGFueTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcsIGNhdXNlOiBNZXNzYWdlU2VuZEVycm9yQ2F1c2UsIHNvdXJjZT86IGFueSwgZGF0YT86IE1lc3NhZ2UpIHtcclxuICAgICAgICBzdXBlcihtZXNzYWdlKTtcclxuXHJcbiAgICAgICAgdGhpcy5jYXVzZSA9IGNhdXNlO1xyXG4gICAgICAgIHRoaXMuc291cmNlID0gc291cmNlO1xyXG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIENsaWVudCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgICBzdGF0dXM6IENvbm5lY3Rpb25TdGF0dXMgPSBDb25uZWN0aW9uU3RhdHVzLkRpc2Nvbm5lY3RlZDtcclxuICAgIHJlc291cmNlOiBzdHJpbmc7XHJcbiAgICBhZ2VudDogc3RyaW5nO1xyXG4gICAgZW5kcG9pbnQ6IHN0cmluZztcclxuICAgIGF1dGhvcml6YXRpb246IHN0cmluZyB8IEF1dGhvcml6YXRpb25GdW5jO1xyXG4gICAgdGltZW91dDogbnVtYmVyID0gNSAqIDEwMDA7XHJcblxyXG4gICAgcHJvdGVjdGVkIF9zb2NrZXQ6IFdlYlNvY2tldDtcclxuICAgIHByb3RlY3RlZCBfbmVlZHNBY2s6IHtbaWQ6c3RyaW5nXTpQZW5kaW5nQWNrQ29udGV4dH0gPSB7fTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcih7ZW5kcG9pbnQsIGF1dGhvcml6YXRpb24sIHRpbWVvdXQgPSA1ICogMTAwMCwgcmVzb3VyY2UgPSAnJywgYWdlbnQgPSAnUmF0YXRvc2tyJywgZXh0ZW5zaW9ucyA9IFtdfTogQ29ubmVjdGlvbk9wdGlvbnMgPSB7fSkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcblxyXG4gICAgICAgIHRoaXMuYWdlbnQgPSBhZ2VudDtcclxuICAgICAgICB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7XHJcbiAgICAgICAgdGhpcy5lbmRwb2ludCA9IGVuZHBvaW50O1xyXG4gICAgICAgIHRoaXMuYXV0aG9yaXphdGlvbiA9IGF1dGhvcml6YXRpb247XHJcbiAgICAgICAgdGhpcy50aW1lb3V0ID0gdGltZW91dDtcclxuXHJcbiAgICAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKChleHQpID0+IHRoaXMudXNlKGV4dCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHVzZShleHQ6IEV4dGVuc2lvbik7XHJcbiAgICB1c2UoZXh0OiBFeHRlbnNpb25Bc0Z1bmMpO1xyXG4gICAgdXNlKGV4dDogYW55KSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBleHQucHJvdG90eXBlLmluaXQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgKG5ldyBleHQoKSkuaW5pdCh0aGlzKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHQuaW5pdCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICBleHQuaW5pdCh0aGlzKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgZXh0KHRoaXMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZXh0SWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHNob3J0aWQuZ2VuZXJhdGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25uZWN0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyAhPT0gQ29ubmVjdGlvblN0YXR1cy5EaXNjb25uZWN0ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBDb25uZWN0aW9uU3RhdHVzLkNvbm5lY3Rpbmc7XHJcblxyXG4gICAgICAgIGRlYnVnKCdjb25uZWN0IGVuZHBvaW50PScsIHRoaXMuZW5kcG9pbnQpO1xyXG5cclxuICAgICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3RpbmcnKTtcclxuXHJcbiAgICAgICAgdmFyIHNvY2tldCA9IG5ldyBXZWJTb2NrZXQodGhpcy5lbmRwb2ludCwgWydyYXRhdG9za3InXSk7XHJcblxyXG4gICAgICAgIHNvY2tldC5vbm9wZW4gPSAoZXZ0KSA9PiB7XHJcbiAgICAgICAgICAgIGRlYnVnKCdjb25uZWN0IG9ub3Blbj0nLCBldnQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fd3NCaW5kKHNvY2tldCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBzb2NrZXQub25lcnJvciA9IChldnQpID0+IHtcclxuICAgICAgICAgICAgZGVidWcoJ2Nvbm5lY3Qgb25lcnJvcj0nLCBldnQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnQ6ZXJyb3InLCBldnQpO1xyXG4gICAgICAgICAgICB0aGlzLl93c0Rpc2Nvbm5lY3Qoc29ja2V0LCBldnQpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgc29ja2V0Lm9uY2xvc2UgPSAoZXZ0KSA9PiB7XHJcbiAgICAgICAgICAgIGRlYnVnKCdjb25uZWN0IG9uY2xvc2U9JywgZXZ0KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZW1pdCgndHJhbnNwb3J0OmNsb3NlJywgZXZ0KTtcclxuICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHNvY2tldCwgZXZ0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGlzY29ubmVjdChyZWFzb246IGFueSA9IHRoaXMpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl93c0Rpc2Nvbm5lY3QodGhpcy5fc29ja2V0LCByZWFzb24pO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBfd3NEaXNjb25uZWN0KHNvY2tldDogV2ViU29ja2V0LCByZWFzb24/OiBhbnkpOiB2b2lkIHtcclxuICAgICAgICBkZWJ1ZygnZGlzY29ubmVjdCByZWFzb249JywgcmVhc29uKTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKHNvY2tldCkge1xyXG4gICAgICAgICAgICAgICAgc29ja2V0Lm9ub3BlbiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBzb2NrZXQub25lcnJvciA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBzb2NrZXQub25tZXNzYWdlID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIHNvY2tldC5vbmNsb3NlID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIHNvY2tldC5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIC8vIG5vdGhpbmcgdG8gZG8gaGVyZSwgd2UgYXJlIHJlbGVhc2luZyB0aGUgc29ja2V0XHJcbiAgICAgICAgfSBmaW5hbGx5IHtcclxuICAgICAgICAgICAgdGhpcy5fc29ja2V0ID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMuX25lZWRzQWNrKS5mb3JFYWNoKChrKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX25lZWRzQWNrW2tdLmRlZmVycmVkLnJlamVjdChyZWFzb24pO1xyXG4gICAgICAgIH0pLCB0aGlzLl9uZWVkc0FjayA9IHt9O1xyXG5cclxuICAgICAgICB0aGlzLnN0YXR1cyA9IENvbm5lY3Rpb25TdGF0dXMuRGlzY29ubmVjdGVkO1xyXG5cclxuICAgICAgICB0aGlzLmVtaXQoJ2Rpc2Nvbm5lY3RlZCcsIHJlYXNvbik7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF93c0JpbmQoc29ja2V0OiBXZWJTb2NrZXQpOiB2b2lkIHtcclxuICAgICAgICBzb2NrZXQub25vcGVuID0gbnVsbDtcclxuICAgICAgICBzb2NrZXQub25lcnJvciA9IHRoaXMuX3dzRXJyb3IuYmluZCh0aGlzKTtcclxuICAgICAgICBzb2NrZXQub25tZXNzYWdlID0gdGhpcy5fd3NNZXNzYWdlLmJpbmQodGhpcyk7XHJcbiAgICAgICAgc29ja2V0Lm9uY2xvc2UgPSB0aGlzLl93c0Nsb3NlLmJpbmQodGhpcyk7XHJcblxyXG4gICAgICAgIHRoaXMuX3NvY2tldCA9IHNvY2tldDtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBDb25uZWN0aW9uU3RhdHVzLkNvbm5lY3RlZDtcclxuXHJcbiAgICAgICAgdGhpcy5lbWl0KCdjb25uZWN0ZWQnKTtcclxuXHJcbiAgICAgICAgdmFyIGF1dGg6IHN0cmluZztcclxuXHJcbiAgICAgICAgYXV0aCA9IHR5cGVvZiB0aGlzLmF1dGhvcml6YXRpb24gPT09ICdmdW5jdGlvbicgPyAoPEF1dGhvcml6YXRpb25GdW5jPnRoaXMuYXV0aG9yaXphdGlvbikoKSA6IDxzdHJpbmc+dGhpcy5hdXRob3JpemF0aW9uO1xyXG5cclxuICAgICAgICB2YXIgbWVzc2FnZSA9IDxBdXRoTWVzc2FnZT57XHJcbiAgICAgICAgICAgIGlkOiB0aGlzLm5leHRJZCgpLFxyXG4gICAgICAgICAgICB0eXBlOiAnYXV0aCcsXHJcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb246IGF1dGhcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAodGhpcy5hZ2VudCkgbWVzc2FnZS5hZ2VudCA9IHRoaXMuYWdlbnQ7XHJcbiAgICAgICAgaWYgKHRoaXMucmVzb3VyY2UpIG1lc3NhZ2UucmVzb3VyY2UgPSB0aGlzLnJlc291cmNlO1xyXG5cclxuICAgICAgICB0aGlzLl93c1NlbmQobWVzc2FnZSkudGhlbigoYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGRlYnVnKCdhdXRoZW50aWNhdGlvbiBhY2s9JywgYWNrKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gQ29ubmVjdGlvblN0YXR1cy5BdXRoZW50aWNhdGVkO1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2F1dGhlbnRpY2F0ZWQnLCBhY2spO1xyXG4gICAgICAgIH0sIChlcnIpID0+IHtcclxuICAgICAgICAgICAgZGVidWcoJ2F1dGhlbnRpY2F0aW9uIGVycm9yPScsIGVycik7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3Byb3RvY29sOmVycm9yJywgZXJyKTtcclxuICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgZXJyKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgX3dzTWVzc2FnZShldnQpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3JhdzppbmNvbW1pbmcnLCBldnQuZGF0YSk7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gSlNPTi5wYXJzZShldnQuZGF0YSk7XHJcbiAgICAgICAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09ICdlcnJvcicpIHtcclxuICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmNvZGUgPT09ICdhdXRoX2ZhaWxlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWJ1ZygnYXV0aGVudGljYXRpb24gZmFpbHVyZT0nLCBtZXNzYWdlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgncHJvdG9jb2w6ZXJyb3InLCBtZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlLnR5cGUgPT09ICdhY2snKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaWQgPSBtZXNzYWdlLnJlcGx5X3RvO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX25lZWRzQWNrW2lkXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX25lZWRzQWNrW2lkXS5kZWZlcnJlZC5yZXNvbHZlKG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudHlwZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KGAke21lc3NhZ2UudHlwZX1gLCBtZXNzYWdlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3Byb3RvY29sOmVycm9yJywgZXJyKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF93c0Vycm9yKGV2dCkge1xyXG4gICAgICAgIHRoaXMuZW1pdCgndHJhbnNwb3J0OmVycm9yJywgZXZ0KTtcclxuICAgICAgICB0aGlzLl93c0Rpc2Nvbm5lY3QodGhpcy5fc29ja2V0LCBldnQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBfd3NDbG9zZShldnQpIHtcclxuICAgICAgICB0aGlzLmVtaXQoJ3RyYW5zcG9ydDpjbG9zZScsIGV2dCk7XHJcbiAgICAgICAgdGhpcy5fd3NEaXNjb25uZWN0KHRoaXMuX3NvY2tldCwgZXZ0KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgX3dzU2VuZChtZXNzYWdlOiBNZXNzYWdlLCB0aW1lb3V0OiBudW1iZXIgPSB0aGlzLnRpbWVvdXQpOiBQcm9taXNlPEFjaz4ge1xyXG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyA8IENvbm5lY3Rpb25TdGF0dXMuQ29ubmVjdGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgTWVzc2FnZVNlbmRFcnJvcignQ2Fubm90IHNlbmQgZGF0YSBhY3Jvc3MgYSBzb2NrZXQgdGhhdCBpcyBub3QgY29ubmVjdGVkLicsIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZS5Ob0F1dGgpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGRlYnVnKCdzZW5kIG1lc3NhZ2U9JywgbWVzc2FnZSk7XHJcblxyXG4gICAgICAgIHZhciBkYXRhO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGRhdGEgPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdwcm90b2NvbDplcnJvcicsIGVycik7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgTWVzc2FnZVNlbmRFcnJvcignQ291bGQgbm90IHNlcmlhbGl6ZSBtZXNzYWdlLicsIE1lc3NhZ2VTZW5kRXJyb3JDYXVzZS5TZXJpYWxpemF0aW9uLCBlcnIsIG1lc3NhZ2UpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZW1pdCgncmF3Om91dGdvaW5nJywgZGF0YSk7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvY2tldCA9IHRoaXMuX3NvY2tldDtcclxuICAgICAgICAgICAgc29ja2V0LnNlbmQoZGF0YSk7XHJcbiAgICAgICAgICAgIGlmIChzb2NrZXQgIT09IHRoaXMuX3NvY2tldCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTb2NrZXQgd2FzIGRlc3Ryb3llZCBkdXJpbmcgc2VuZC4nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICBkZWJ1Zygnc2VuZCBleGNlcHRpb249JywgZXJyKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnQ6ZXJyb3InLCBlcnIpO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0FuIGVycm9yIG9jY3VycmVkIGluIHRoZSB0cmFuc3BvcnQuJywgTWVzc2FnZVNlbmRFcnJvckNhdXNlLlRyYW5zcG9ydCwgZXJyLCBtZXNzYWdlKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobWVzc2FnZS5pZCkge1xyXG4gICAgICAgICAgICB2YXIgaWQgPSBtZXNzYWdlLmlkO1xyXG4gICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSBkZWZlcigpO1xyXG4gICAgICAgICAgICB2YXIgcGVuZGluZyA9IHRoaXMuX25lZWRzQWNrW2lkXSA9IHtcclxuICAgICAgICAgICAgICAgIGlkOiBpZCxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICBkZWZlcnJlZDogZGVmZXJyZWQsXHJcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBkZWJ1Zygnc2VuZCB0aW1lb3V0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBNZXNzYWdlU2VuZEVycm9yKCdEaWQgbm90IHJlY2VpdmUgYWNrbm93bGVkZ2VtZW50IGluIHRoZSB0aW1lb3V0IHBlcmlvZC4nLCBNZXNzYWdlU2VuZEVycm9yQ2F1c2UuTm9BY2ssIHZvaWQgMCwgbWVzc2FnZSkpXHJcbiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB2YXIgY2xlYW51cCA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChwZW5kaW5nLnRpbWVvdXQpO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX25lZWRzQWNrW2lkXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZS50aGVuKChhY2spID0+IHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKCdzZW5kIGFjaz0nLCBhY2spO1xyXG5cclxuICAgICAgICAgICAgICAgIGNsZWFudXAoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhY2s7XHJcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKCdzZW5kIGVycm9yPScsIGVycik7XHJcblxyXG4gICAgICAgICAgICAgICAgY2xlYW51cCgpO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0FuIGVycm9yIG9jY3VycmVkIGR1cmluZyBwcm9taXNlIHJlc29sdXRpb24nLCBNZXNzYWdlU2VuZEVycm9yQ2F1c2UuUHJvbWlzZSwgZXJyLCBtZXNzYWdlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZW5kKG1lc3NhZ2U6IE1lc3NhZ2UpOiBQcm9taXNlPEFjaz4ge1xyXG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyA8IENvbm5lY3Rpb25TdGF0dXMuQXV0aGVudGljYXRlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IE1lc3NhZ2VTZW5kRXJyb3IoJ0Nhbm5vdCBzZW5kIGRhdGEgYWNyb3NzIGEgc29ja2V0IHRoYXQgaXMgbm90IGF1dGhlbnRpY2F0ZWQuJywgTWVzc2FnZVNlbmRFcnJvckNhdXNlLk5vQXV0aCwgdm9pZCAwLCBtZXNzYWdlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLl93c1NlbmQobWVzc2FnZSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2Vuc3VyZUNhbkFjayhhY2s6IGJvb2xlYW4sIG1lc3NhZ2U6IE1lc3NhZ2UpOiBNZXNzYWdlIHtcclxuICAgICAgICBpZiAoYWNrICYmICEoJ2lkJyBpbiBtZXNzYWdlKSkgeyBtZXNzYWdlLmlkID0gdGhpcy5uZXh0SWQoKTsgfVxyXG4gICAgICAgIHJldHVybiBtZXNzYWdlO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbmRQaW5nKG1lc3NhZ2U6IFBpbmdNZXNzYWdlID0ge30sIGFjazogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFjaz4ge1xyXG4gICAgICAgIG1lc3NhZ2UudHlwZSA9ICdwaW5nJztcclxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKHRoaXMuX2Vuc3VyZUNhbkFjayhhY2ssIG1lc3NhZ2UpKTtcclxuICAgIH1cclxuXHJcbiAgICBzZW5kQ2hhdChtZXNzYWdlOiBDaGF0TWVzc2FnZSwgYWNrOiBib29sZWFuID0gdHJ1ZSk6IFByb21pc2U8QWNrPiB7XHJcbiAgICAgICAgbWVzc2FnZS50eXBlID0gJ2NoYXQnO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQodGhpcy5fZW5zdXJlQ2FuQWNrKGFjaywgbWVzc2FnZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbmRQcmVzZW5jZUNoYW5nZShtZXNzYWdlOiBQcmVzZW5jZUNoYW5nZU1lc3NhZ2UsIGFjazogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxBY2s+IHtcclxuICAgICAgICBtZXNzYWdlLnR5cGUgPSAncHJlc2VuY2VfY2hhbmdlJztcclxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKHRoaXMuX2Vuc3VyZUNhbkFjayhhY2ssIG1lc3NhZ2UpKTtcclxuICAgIH1cclxuXHJcbiAgICBzZW5kVXNlclR5cGluZyhtZXNzYWdlOiBVc2VyVHlwaW5nTWVzc2FnZSwgYWNrOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEFjaz4ge1xyXG4gICAgICAgIG1lc3NhZ2UudHlwZSA9ICd1c2VyX3R5cGluZyc7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh0aGlzLl9lbnN1cmVDYW5BY2soYWNrLCBtZXNzYWdlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VuZFRlYW1Kb2luKG1lc3NhZ2U6IFRlYW1Kb2luTWVzc2FnZSwgYWNrOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEFjaz4ge1xyXG4gICAgICAgIG1lc3NhZ2UudHlwZSA9ICd0ZWFtX2pvaW4nO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQodGhpcy5fZW5zdXJlQ2FuQWNrKGFjaywgbWVzc2FnZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbmRUZWFtTGVhdmUobWVzc2FnZTogVGVhbUxlYXZlTWVzc2FnZSwgYWNrOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPEFjaz4ge1xyXG4gICAgICAgIG1lc3NhZ2UudHlwZSA9ICd0ZWFtX2xlYXZlJztcclxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKHRoaXMuX2Vuc3VyZUNhbkFjayhhY2ssIG1lc3NhZ2UpKTtcclxuICAgIH1cclxufVxyXG4iXX0=